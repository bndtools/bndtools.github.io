<html lang="en">
  <head>
    <!-- Redirect to the new location -->
    <meta http-equiv="Refresh" content="0; url=/workspace/osgi-starter.html" />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Asciidoctor 2.0.10" />
    <meta name="author" content="Peter.Kriens@aQute.biz" />
    <title>OSGi Starter</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"
    />
    <link rel="stylesheet" href="./asciidoctor.css" />
  </head>
  <!-- TODO remove the content soon, to avoid duplicate content. Keep it briefly to verify during migration to markdown in osgi-starter.md -->
  <body class="book">
    <div id="header">
      <div id="toc" class="toc">
        <div id="toctitle">Table of Contents</div>
        <ul class="sectlevel1">
          <li><a href="#_tldr">TL;DR</a></li>
          <li><a href="#_introduction">Introduction</a></li>
          <li><a href="#_starting_with_osgi">Starting with OSGi</a></li>
          <li><a href="#_gogo">Gogo</a></li>
          <li><a href="#_a_new_gogo_command">A New Gogo Command</a></li>
          <li><a href="#_api_bundle">API Bundle</a></li>
          <li><a href="#_provider_bundle">Provider Bundle</a></li>
          <li><a href="#_junit_testing">JUnit Testing</a></li>
          <li><a href="#_external_dependencies">External Dependencies</a></li>
          <li><a href="#_application">Application</a></li>
          <li><a href="#_gradle">Gradle</a></li>
          <li><a href="#_git">Git</a></li>
          <li>
            <a href="#_release_to_remote_repository"
              >Release to Remote Repository</a
            >
          </li>
          <li><a href="#_the_end">The End</a></li>
        </ul>
      </div>
    </div>
    <div id="content">
      <div class="sect1">
        <h2 id="_tldr">TL;DR</h2>
        <div class="sectionbody">
          <div class="paragraph">
            <p>
              First, OSGi is about <em>complex</em> systems. It is not some
              secret sauce library you can sprinkle over your application and
              hope it will be improved. It is a pretty fundamental choice.
              Therefore, if you find this document too long, you likely are not
              in the market for OSGi. OSGi shines for complex systems and not
              for a hello world example.
            </p>
          </div>
          <div class="paragraph">
            <p>
              However, if you&#8217;re too hurried to do a nice cozy read of
              this book then I suggest you first follow the
              <a href="http://bndtools.org/workspace.html">Bndtool videos</a>.
              (And even those start with a TL;DR!). This document follows the
              same structure. If you then want to explore things in more detail
              you&#8217;re welcome back!
            </p>
          </div>
          <div class="paragraph">
            <p>You can skip the introduction since it is a bit of smalltalk.</p>
          </div>
        </div>
      </div>
      <div class="sect1">
        <h2 id="_introduction">Introduction</h2>
        <div class="sectionbody">
          <div class="paragraph">
            <p>
              Documenting languages always seemed much more fun than elucidating
              OSGi. First, most developers can relate quickly to another
              language using examples like Hello World because the underlying
              concepts are so similar for most languages. However, some of the
              truly innovative things in OSGi are too unfamiliar to use such
              simplistic examples; they do require some effort from the student.
            </p>
          </div>
          <div class="paragraph">
            <p>
              I generally addressed this large conceptual distance by making
              lots of pictures and diagrams, preferably with lots of animations.
              However, I often felt the audience drifting to thinking about what
              they should eat that evening instead of grasping these concepts.
            </p>
          </div>
          <div class="paragraph">
            <p>
              I do not think I was alone in this because there are a large
              number of OSGi Hello World tutorials on the web where the
              accompanying text shows a certain disdain to OSGi developers. Why
              had we not explained OSGi better to them? Why were there no good
              tutorials explaining this simple and fantastic technology? It
              isn&#8217;t so hard? And with that, they made another "Hello
              World" tutorial that was as incomprehensible to a newcomer as the
              one they were rejecting.
            </p>
          </div>
          <div class="paragraph">
            <p>
              I do take some comfort in that there were many of those tutorials,
              implying that these authors did not really learn that much from
              each other as the authors thought. Once you <em>get</em> OSGi, it
              is actually quite simple and immensely powerful. However, to
              <em>get</em> it, you actually need to <em>understand</em> it. And
              that was the rub. OSGi often feels to newcomers like a tangled
              mess until just before the light goes on.
            </p>
          </div>
          <div class="paragraph">
            <p>
              One day, while preparing a course, I realized that OSGi actually
              has a hidden gem called <em>Gogo</em>. Around 2008 I&#8217;d
              developed a Proof of Concept (PoC) of a
              <a href="https://osgi.org/download/osgi-4.3-early-draft2.pdf"
                >Command Line Interface</a
              >
              to launch and configure an OSGi framework. It combined the idea of
              an object-oriented language with the ease of use of a command-line
              shell like bash. It can basically do anything you can do in plain
              Java and it is trivial to add new commands from OSGi. It even
              supported piping commands.
            </p>
          </div>
          <div class="paragraph">
            <p>
              The shell never became standardized by the
              <a href="https://www.osgi.org">OSGi Alliance</a> since we felt
              that there was no real need to have a standardized shell. As long
              as the Framework was standardized, companies could pick any shell
              and still have portability. However, TSH was actually quite cool
              and I therefore donated it to Apache Felix, where it became
              <em>Gogo</em>. Several companies picked it up and the proof of
              concept was transformed into a serious piece of software, becoming
              quite successful over time. In particular the work to adapt it to
              Apache Karaf improved Gogo significantly. Even Equinox, the
              Eclipse framework, switched to Gogo as its primary shell.
            </p>
          </div>
          <div class="paragraph">
            <p>
              Clearly, Gogo could be used in a minimal framework without any
              IDE. Though I am generally in the camp of learning from first
              principles, I felt that just having a framework with Gogo would
              not suffice. After all, OSGi is not about building small programs,
              OSGi is about beating complexity. When the environment cannot
              handle complexity it is really hard to show the benefits of OSGi.
            </p>
          </div>
          <div class="paragraph">
            <p>
              Therefore, I decided to run Gogo inside <em>Bndtools</em> to show
              the cool features of OSGi.
            </p>
          </div>
          <div class="paragraph">
            <p>
              The bnd tool started around 2000 while I was working for Ericsson
              because I am lazy and distinctly disliked writing the required
              OSGi metadata in the manifest. Through Neil Bartlett, bnd turned
              into a very elegant Eclipse plugin called <em>Bndtools</em>. Over
              the past years, a large number of companies have adopted Bndtools
              and its sidekick Gradle.
            </p>
          </div>
          <div class="paragraph">
            <p>
              A mature environment like Bndtools hides a lot of complexity that
              easily obscures important concepts. This makes it harder to see
              how things actually work under the hood. If it looks like magic it
              is hard to understand what is happening on the lower layers.
            </p>
          </div>
          <div class="paragraph">
            <p>
              However, the advantage with Bndtools is that, out of the box, it
              creates correct bundles with no special setup. Since Bndtools can
              run OSGi frameworks in many different setups, it is easy to show
              all the aspects of OSGi. Most importantly, since Bndtools keeps a
              live framework updated of any changes in the IDE, OSGi feels like
              an <em>interactive</em> environment, i.e. similar to a
              Repeat-Eval-Print-Loop (REPL) that makes so many languages a joy
              to learn. You change some Java code and it is available inside
              OSGi, using the dynamic nature of OSGi to do the updates. This
              dynamic nature makes it worth learning OSGi &amp; bnd in Bndtools
              even if you use Maven as your build system. (bnd is present in
              Maven plugins.)
            </p>
          </div>
          <div class="paragraph">
            <p>
              Therefore, this book uses a combination of the Gogo shell and
              Bndtools to explore OSGi. It starts by installing Bndtools and a
              <em>bnd workspace</em>. A playground project is then created to
              run a framework with the Gogo shell. From there, we first will
              explore the shell itself to learn the features. After feeling
              comfortable with the existing commands, we add a custom 'Hello
              World' command using the OSGi Declarative Services.
            </p>
          </div>
          <div class="paragraph">
            <p>
              We go very lightly on the basic concepts in this book. We skip all
              the background and instead focus on building a trivial application
              that has the correct scalable architecture.
            </p>
          </div>
          <div class="paragraph">
            <p>
              The next phase is, therefore, to create an absolutely minimal
              <em>workspace</em> with an API project and a provider of this API,
              the architectural keystone of OSGi applications. We will explore
              how to test the code with plain JUnit both inside and outside an
              OSGi framework.
            </p>
          </div>
          <div class="paragraph">
            <p>
              The core concept of OSGi is to build applications of reusable
              components. The previous sections created a reusable component so
              next comes the application. The application is the code that is
              never reusable, it only works for a specific environment and
              configuration.
            </p>
          </div>
          <div class="paragraph">
            <p>
              The preferred delivery format in bnd is the
              <em>executable</em> jar. This is a JAR file that contains a
              <em>launcher</em>, a framework, and all necessary dependencies. We
              show how to define an application project and export it
              automatically to an executable JAR. Such an executable JAR can
              then be deployed to the target environment.
            </p>
          </div>
          <div class="paragraph">
            <p>
              If you are a user of a bnd workspace and there is
              <em>build master</em> that maintains the low level details then
              you don&#8217;t need to continue with this document. It is then
              highly recommended to subscribe to the
              <a href="https://bndtools.org/community.html"
                >Bndtools mailing list</a
              >.
            </p>
          </div>
          <div class="paragraph">
            <p>The remainder of the document discusses how to:</p>
          </div>
          <div class="ulist">
            <ul>
              <li>
                <p>Build the workspace with Gradle</p>
              </li>
              <li>
                <p>
                  Use Github Actions to build your workspace on a remote server
                </p>
              </li>
              <li>
                <p>
                  Release snapshots and releases to Sonatype Nexus repository
                </p>
              </li>
            </ul>
          </div>
          <div class="paragraph">
            <p>
              Enjoy! And do not forget to provide feedback to improve this
              document.
            </p>
          </div>
          <div class="paragraph">
            <p><a href="mailto:peter.kriens@aQute.biz">Peter Kriens</a></p>
          </div>
        </div>
      </div>
      <div class="sect1">
        <h2 id="_starting_with_osgi">Starting with OSGi</h2>
        <div class="sectionbody">
          <div class="sect2">
            <h3 id="_tldr_2">TL;DR</h3>
            <div class="paragraph">
              <p>
                This section will start with a hands-on deep dive into OSGi. We
                will install Bndtools and then create a playground project so we
                can explore OSGi and Bndtools in detail interactively. This kind
                of a crucial, and short, section to get started with Bndtools.
                It creates a running framework with a Gogo shell. This is very
                much the start level of all other chapters. So skip at your
                peril.
              </p>
            </div>
            <div class="paragraph">
              <p>
                You can find a workspace with the work done in this book at
                <a href="https://github.com/aQute-os/com.example" class="bare"
                  >https://github.com/aQute-os/com.example</a
                >. Please have a Java 8 VM installed.
              </p>
            </div>
            <div class="paragraph">
              <p>
                You can follow a short video at
                <a href="https://bndtools.org/workspace.html#install"
                  >bndtools.org</a
                >.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_installing">Installing</h3>
            <div class="paragraph">
              <p>
                Install Eclipse &amp; Bndtools. The following link can be used
                to find out how to install these tools.
              </p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>
                    <a
                      href="https://bndtools.org/installation.html"
                      class="bare"
                      >https://bndtools.org/installation.html</a
                    >
                  </p>
                </li>
              </ul>
            </div>
            <div class="paragraph">
              <p>
                The following sections assume that you have an empty Eclipse
                workspace up and running in a directory called
                <code>com.example</code>. This Eclipse workspace directory will
                also be used for bnd and later Git.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_about_java">About Java</h3>
            <div class="paragraph">
              <p>
                Once upon a time, Java was stable for years but this changed
                after Java 9. Nowadays, there are frequent releases. This would
                not be a problem if Java were kept perfectly backward
                compatible. However, the introduction of a module system and
                some tiny details make this not so. Also, tools like Eclipse and
                Bndtools sometimes have information that can lack the
                information about the latest version. Last, in the embedded
                world there is always a lag. For this last reason, the book is
                written against Java 8.
              </p>
            </div>
            <div class="paragraph">
              <p>
                It should be possible to run everything on later Java versions
                but your mileage may vary. It is highly recommended to install
                at least one Java 8 JDK.
              </p>
            </div>
            <div class="paragraph">
              <p>
                For the exercises to work, you should select a Java 1.8 JRE,
                which is the default in Eclipse. See
                <span class="menuseq"
                  ><b class="menu">Eclipse</b>&#160;<b class="caret">&#8250;</b>
                  <b class="menuitem"
                    >Preferences&#8594;Java&#8594;Installed JREs</b
                  ></span
                >
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="img/bndtools-jres.png" alt="bndtools jres" />
              </div>
            </div>
            <div class="admonitionblock warning">
              <table>
                <tr>
                  <td class="icon">
                    <div class="title">Warning</div>
                  </td>
                  <td class="content">
                    At the time of writing this document, Eclipse did not
                    support Java 13 and 14 yet.
                  </td>
                </tr>
              </table>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_filters_in_the_bndtools_explorer">
              Filters in the Bndtools Explorer
            </h3>
            <div class="paragraph">
              <p>
                By default, Eclipse filters files that start with a dot
                (<code>.</code>). Since the dotfiles are often quite interesting
                to look at, it is best to disable this filtering. In the
                Bndtools Explorer, select the
                <a
                  href="https://help.eclipse.org/2019-12/index.jsp?topic=%2Forg.eclipse.platform.doc.user%2Ftasks%2Ftasks-48b.htm"
                  >little triangle or 3 dots in the top right of the view</a
                >
                to open the menu. Then select <code>Filters</code>. Just
                enable/disable the filters you want.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="img/bndtools-filters.png" alt="bndtools filters" />
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_workspace_setup">Workspace Setup</h3>
            <div class="paragraph">
              <p>
                The bnd tool uses the concept of a <em>workspace</em>. A
                workspace is a directory with a <em>configuration</em> directory
                (<code>cnf</code>) and a directory for each <em>project</em>.
                (Not nested!). The bnd workspace can overlap with the Git
                workspace, the Gradle workspace, and the Eclipse workspace.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Bndtools has a <em>preference</em> that lists workspace
                <em>templates</em>. In this tutorial, we&#8217;ll use a minimum
                template.
              </p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>
                    <span class="menuseq"
                      ><b class="menu">Preferences</b>&#160;<b class="caret"
                        >&#8250;</b
                      >
                      <b class="submenu">Bndtools</b>&#160;<b class="caret"
                        >&#8250;</b
                      >
                      <b class="menuitem">Workspace Template</b></span
                    >
                  </p>
                </li>
              </ul>
            </div>
            <div class="imageblock">
              <div class="content">
                <img
                  src="img/pref-workspace-template.png"
                  alt="pref workspace template"
                />
              </div>
            </div>
            <div class="paragraph">
              <p>
                Ensure that the <em>template</em>
                <code>bndtools/bndtools.workspace.min</code> is in this list for
                the <code>master</code> branch. Press the
                <b class="button">Validate</b> button to verify that you entered
                this template&#8217;s address correctly. You can find the
                content of this workspace template here:
              </p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>
                    <a
                      href="https://github.com/bndtools/bndtools.workspace.min"
                      class="bare"
                      >https://github.com/bndtools/bndtools.workspace.min</a
                    >
                  </p>
                </li>
              </ul>
            </div>
            <div class="paragraph">
              <p>
                After installing the template, be sure to select the
                <em>Bndtools</em> perspective:
              </p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>
                    <span class="menuseq"
                      ><b class="menu">Window</b>&#160;<b class="caret"
                        >&#8250;</b
                      >
                      <b class="submenu">Perspective</b>&#160;<b class="caret"
                        >&#8250;</b
                      >
                      <b class="submenu">Open Perspective</b>&#160;<b
                        class="caret"
                        >&#8250;</b
                      >
                      <b class="menuitem">Bndtools</b></span
                    >
                  </p>
                </li>
              </ul>
            </div>
            <div class="paragraph">
              <p>
                After you selected the Bndtools perspective, the explorer shows
                the cnf directory.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="img/cnf-build.png" alt="cnf build" />
              </div>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>
                    <code>.settings</code> – Eclipse settings like the compiler
                    to be used, formatting rules, etc.
                  </p>
                </li>
                <li>
                  <p>
                    <code>cache</code> – Used by bnd to cache files, must be
                    ignored by Git
                  </p>
                </li>
                <li>
                  <p>
                    <code>ext</code> – Extensions. Any properties file having an
                    extension <code>.bnd</code> will be visible to all projects.
                  </p>
                </li>
                <li>
                  <p>
                    <code>.project</code> – Project setup for Eclipse, do not
                    touch
                  </p>
                </li>
                <li>
                  <p>
                    <code>build.bnd</code> – A property file that contains the
                    setup for this workspace. Anything defined in this file (or
                    in a <code>bnd</code> file in the <code>ext</code> directory
                    will be available to all projects.)
                  </p>
                </li>
              </ul>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_new_project">New Project</h3>
            <div class="paragraph">
              <p>Create a new project to verify the setup.</p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>
                    <span class="menuseq"
                      ><b class="menu">File</b>&#160;<b class="caret"
                        >&#8250;</b
                      >
                      <b class="submenu">New</b>&#160;<b class="caret"
                        >&#8250;</b
                      >
                      <b class="menuitem">Bndtools OSGi Project</b></span
                    >
                  </p>
                </li>
              </ul>
            </div>
            <div class="imageblock">
              <div class="content">
                <img
                  src="img/new-project-template.png"
                  alt="new project template"
                />
              </div>
            </div>
            <div class="paragraph">
              <p>
                Projects can be created from <em>templates</em>. We are using
                the <code><a href="#empty">[empty]</a></code> template that is
                part of Bndtools.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="img/new-project-name.png" alt="new project name" />
              </div>
            </div>
            <div class="paragraph">
              <p>
                Enter the name of the project. Note that the name of the project
                is also the name of the bundle (a.k.a. the Bundle symbolic
                name). It is recommended, for this book, to use fully qualified
                names like <code>com.example.playground</code>.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Make sure the <code>JavaSE-1.8</code> execution environment is
                selected in the popup, then click <b class="button">Next</b>.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img
                  src="img/new-project-layout.png"
                  alt="new project layout"
                />
              </div>
            </div>
            <div class="paragraph">
              <p>
                Note that the <code>Create module-info.java file</code> option
                must be disabled. If it is enabled, you&#8217;re using a &gt;9
                Java VM. In that case, make sure you know what you&#8217;re
                doing, it must then likely be disabled.
              </p>
            </div>
            <div class="paragraph">
              <p>
                After you&#8217;ve clicked on <b class="button">Finish</b>, you
                will see a new project.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="img/project-files.png" alt="project files" />
              </div>
            </div>
            <div class="paragraph">
              <p>
                After the project is created, you can find the following files
                in it:
              </p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>
                    <code>JRE System Library</code> – Links Eclipse with the
                    correct JDK
                  </p>
                </li>
                <li>
                  <p>
                    <code>src/main/java</code> – The source directory of the
                    project. This is where the Java code goes
                  </p>
                </li>
                <li>
                  <p>
                    <code>src/main/resources</code> – The resource directory of
                    the project. This is for bundle resources like images and
                    other files
                  </p>
                </li>
                <li>
                  <p>
                    <code>Bnd Bundle Path</code> – Links Elipse to the bnd
                    <em>buildpath</em> defined in the <code>bnd</code> file.
                    These are the source and test dependencies for this project
                  </p>
                </li>
                <li>
                  <p>
                    <code>.settings</code> – Eclipse settings like the compiler,
                    formatting rules, etc.
                  </p>
                </li>
                <li>
                  <p><code>src</code> – Top-level src directory</p>
                </li>
                <li>
                  <p>
                    <code>target</code> – Contains all generated files. This
                    directory is not stored on Github
                  </p>
                </li>
                <li>
                  <p>
                    <code>.classpath</code> – Project setup for Eclipse. Do not
                    touch
                  </p>
                </li>
                <li>
                  <p>
                    <code>.project</code> – Project setup for Eclipse. Do not
                    touch
                  </p>
                </li>
                <li>
                  <p>
                    <code>bnd.bnd</code> – A property file that contains the
                    setup for this project. It inherits from
                    <code>cnf/build.bnd</code>
                  </p>
                </li>
                <li>
                  <p>&#8230;&#8203;</p>
                </li>
              </ul>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_running">Running</h3>
            <div class="paragraph">
              <p>
                To verify that the project is correctly set up, we&#8217;ll run
                the Gogo shell in an OSGi framework. To keep it simple,
                we&#8217;ll be running an OSGi <em>framework</em> with the
                <em>Gogo</em> shell as the only bundles.
              </p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>
                    Double click on the <code>bnd.bnd</code> file. This opens
                    the <em>bnd editor</em>.
                  </p>
                </li>
                <li>
                  <p>Select the <b class="button">Run</b> tab</p>
                </li>
                <li>
                  <p>
                    Enter <code>gogo</code> in the
                    <b class="button">Enter Search string</b> widget, this
                    selects all bundles with <code>gogo</code> in their name
                  </p>
                </li>
                <li>
                  <p>
                    Drag the <code>com.example.playground</code>,
                    <code>org.apache.felix.gogo.command</code>, and
                    <code>org.apache.felix.gogo.shell</code> to the
                    <b class="button">Run Requirements</b> list
                  </p>
                </li>
                <li>
                  <p>Press <b class="button">Resolve</b></p>
                </li>
                <li>
                  <p>Press <b class="button">Update</b></p>
                </li>
                <li>
                  <p>Save</p>
                </li>
                <li>
                  <p>Press <b class="button">Debug OSGi</b></p>
                </li>
              </ul>
            </div>
            <div class="paragraph">
              <p>
                This opens the shell in the Eclipse console. You can enter
                <code>lb -s</code> to see the bundles that are running in the
                framework.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="img/run-console-gogo.png" alt="run console gogo" />
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_summary">Summary</h3>
            <div class="paragraph">
              <p>
                We&#8217;ve installed Eclipse and then created an Eclipse
                workspace. The Eclipse workspace was then turned into a
                <em>bnd</em> workspace from a Github template.
              </p>
            </div>
            <div class="paragraph">
              <p>We then created a project as a playground for Gogo.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="sect1">
        <h2 id="_gogo">Gogo</h2>
        <div class="sectionbody">
          <div class="sect2">
            <h3 id="_tldr_3">TL;DR</h3>
            <div class="paragraph">
              <p>
                This section explains how to use Gogo so that the remaining
                chapters can use Gogo to <em>explore</em> the examples, making
                much of the book very interactive.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Gogo is much more powerful than most people think. As a minimum,
                you should try to run the Gogo shell in the playground project
                and try to understand commands like <code>help</code>,
                <code>echo</code>, <code>(bundle 0) headers</code>, and
                <code>s=bundle 1</code>.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_gogo_shells">Gogo &amp; Shells</h3>
            <div class="paragraph">
              <p>
                The Gogo shell <em>feels</em> like a bash shell that closely
                interacts with the OSGi framework. Gogo was designed to allow
                human users as well as programs to interact with an OSGi based
                system through a command-line based interface, also called a
                <em>shell</em>. This shell should allow interactive and
                string-based programmatic access to the core features of the
                framework as well as providing access to functionality that
                resides in bundles. However, I also wanted it to be a scripting
                language that would work with real Java objects.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Shells can be used from many different sources, for example, the
                built-in Eclipse console but sometimes also from an SSH client.
                It is, therefore, necessary to have a flexible scheme that
                allows bundles to provide shell fronts based on telnet, ssh, the
                Java Console class, plain Java console, serial ports, files,
                etc. Supporting commands from bundles was made to be very
                lightweight to promote supporting the shell from any bundle.
              </p>
            </div>
            <div class="paragraph">
              <p>
                In this section, we explore the usage aspect of the Gogo shell.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_at_startup">At Startup</h3>
            <div class="paragraph">
              <p>When the Gogo shell starts, it prints out the following:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    ____________________________
    Welcome to Apache Felix Gogo
    g!</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_commands">Commands</h3>
            <div class="paragraph">
              <p>
                The most simple command is <code>echo</code> which works as any
                developer should expect.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! echo Hello World
    Hello World</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_help">Help</h3>
            <div class="paragraph">
              <p>
                The <code>org.apache.felix.gogo.command</code> bundle provides a
                large number of commands. You can see those commands with the
                <code>help</code> function:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! help
    gogo:cat
    gogo:each
    gogo:echo
    gogo:format
    gogo:getopt
    gogo:gosh
    gogo:grep
    gogo:history
    gogo:not
    gogo:set
    gogo:sh
    gogo:source
    gogo:tac
    gogo:telnetd
    gogo:type
    gogo:until
    ...</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                The list shows the <em>scope</em> (e.g. <code>gogo</code>) and
                the <code>function</code> name (e.g. <code>grep</code>).
              </p>
            </div>
            <div class="paragraph">
              <p>
                The actual list is likely longer because many bundles provide
                additional commands.
              </p>
            </div>
            <div class="paragraph">
              <p>
                You can get more information about a command with the
                <code>help</code> command by providing the name of the command:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! help echo
    echo
        scope: gogo
        parameters:
            Object[]</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_historyediting">History/Editing</h3>
            <div class="paragraph">
              <p>
                In the Eclipse console, you can unfortunately not edit the
                commands. However, you can access the history.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! history
     1 echo Hello World
     2 help
     3 help echo</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>You can repeat a command using the bang (<code>'!'</code>):</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="CodeRay highlight"><code data-lang="shell">    g! !1
    Hello World
    g! !ech
    Hello World</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                In standard terminals, you can use the cursor keys to move back
                and forth. Unfortunately, this not yet supported by Eclipse.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_cheat_sheet">Cheat Sheet</h3>
            <div class="paragraph">
              <p>
                The following is a cheat sheet of the Gogo shell. You can ignore
                it for now but it might be a nice reference in the future.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    program    ::= executable ( '|' statements )*
    statements  ::= statement ( ';' statement )*
    statement   ::= assignment | expression
    assignment  ::= token '=' expression
    expression  ::= list | map | range | closure | command | variable | ne | '(' expression ')'
    command     ::= target | function
    target      ::= expression token ( ' ' expression)*
    function    ::= token ( ' ' expression)*
    list        ::= '[' expression ( ' ' expression )* ']'
    range       ::= '[' expression '..' expression ( '..' expression )? ']'
    map         ::= '[' assignment ( ' ' assignment )* ']'
    closure     ::= '{' program '}'
    ne          ::= '%(' &lt;numeric expression&gt; ')'
    variable    ::= '$' token
    token       ::= &lt;complicated&gt;</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Special characters can be escaped by quoting them (double or
                single quotes) or prefixing them with a backslash
                (<code>'\'</code>). Numeric expressions support common Math
                functions.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Tokens are parsed more or less as a sequence of characters
                without whitespace or any of the special characters in
                <code>[](){};|&amp;&gt;</code>. A special rule applies to the
                curly brace token (<code>{</code>). If it is followed by
                whitespace it is a separate token, otherwise it is concatenated
                with the rest. (Don&#8217;t ask me why, I probably suffered from
                some obscure use case in my mind.)
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_quoting">Quoting</h3>
            <div class="paragraph">
              <p>
                Quoting (double or single) is optional if the word does not
                contain spaces or some special characters like '|', ';', and
                some others. So in this case two tokens are passed to echo.
                Notice that we can quote the two words turning it into a single
                token:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! echo Hello                     World
    Hello World
    g! echo 'Hello                     World'
    Hello                     World</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_multiple_commands">Multiple Commands</h3>
            <div class="paragraph">
              <p>
                You can execute multiple commands on a line by separating the
                commands with a semicolon (<code>';'</code>).
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! echo Hello; echo World
    Hello
    World</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Multiple commands can also be separated by a
                <em>pipe</em> character (<code>'|'</code>). In that case, the
                output is the input of the next command. Gogo has a built-in
                <code>grep</code> command so we can use <code>echo</code> to
                create output and <code>grep</code> to check the output.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! echo Hello | grep Hello
    Hello
    true
    g! echo Hello | grep World
    Hello
    false</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_io_redirection">IO Redirection</h3>
            <div class="paragraph">
              <p>
                Two built-in commands <code>cat</code> and <code>tac</code> (
                tac = reversed <code>cat</code> because it writes instead of
                reads) are available to provide file data and store file data.
                Together with the pipe operator, they replace the input and
                output redirection of the bash shell.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! echo Hello | tac temp.txt
    Hello
    g! echo World | tac -a temp.txt
    World
    g! cat temp.txt
    Hello
    World</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_built_in_commands">Built-in Commands</h3>
            <div class="paragraph">
              <p>
                Gogo&#8217;s commands are methods on <em>objects</em>. By
                default, Gogo adds all public methods of the
                <code>java.lang.System</code> class and the public methods on
                the session&#8217;s <code>BundleContext</code> as commands.
                Instead of directly using the method names, Gogo uses the
                <em>bean</em> naming standard. That is,
                <code>getHeaders()</code> becomes <code>headers</code>.
              </p>
            </div>
            <div class="paragraph">
              <p>This gives us access to some interesting System functions:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! currenttimemillis
    1458158111374
    g! property user.dir
    /Ws/enroute/osgi.enroute.examples/osgi.enroute.gogo.commands.provider
    g! nanotime
    1373044343558515
    g! identityhashcode abc
    828301628
    g! property foo FOO
    g! property foo
    FOO
    g! env JAVA_HOME
    /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home
    g! gc
    g!</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_errors">Errors</h3>
            <div class="paragraph">
              <p>
                If Gogo cannot find a command, it will print a message like:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! hello
    gogo: CommandNotFoundException: Command not found: hello</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                This should be clear. However, sometimes it prints an Illegal
                Argument Exception:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! bundle 1 headers
    gogo: IllegalArgumentException:
        Cannot coerce bundle(Token, Token) to any of [
                (long),
                (),
                (String)
        ]</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                In this case, Gogo <em>did</em> find a method with the given
                name (<code>bundle</code> in the previous example) but it could
                not match the parameters to the available methods. In the
                example, there are three methods available:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    (long)      =&gt; getBundle(long)
    ()          =&gt; getBundle()
    (String)    =&gt; getBundle(String)</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                However, it was called with
                <code>getBundle(Token,Token)</code> and therefore did not match
                any of the available methods.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_variables">Variables</h3>
            <div class="paragraph">
              <p>
                Variables can have any name. They are set with
                <code>&lt;name&gt;=&lt;expr&gt;</code>. They are referred to by
                <code>$&lt;name&gt;</code>. Gogo uses variables also itself. For
                example, the prompt can be changed by setting a new
                <code>prompt</code> variable.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! prompt= '$ '
    $</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>The following variables are in use by the shell:</p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>
                    <code>e</code> – A function to print the last
                    exception&#8217;s stack trace
                  </p>
                </li>
                <li>
                  <p><code>exception</code> – The last exception</p>
                </li>
                <li>
                  <p><code>prompt</code> – The shell prompt</p>
                </li>
              </ul>
            </div>
            <div class="paragraph">
              <p>
                You can also use the <code>${&#8230;&#8203;}</code> pattern in a
                token to access variables:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! name=World
    g! &quot;Hello ${name}&quot;
    Hello World</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>You can remove a variable by not providing a value:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! foo=1
    1
    g! $foo
    1
    g! foo=
    1
    g! $foo
    g!</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_objects">Objects</h3>
            <div class="paragraph">
              <p>
                Notice that none of the System commands required anything
                special, they are just the methods defined on the System class.
                That implies that the implementation has no clue about Gogo. All
                these commands return domain, plain, unadorned objects. We can
                test this because Gogo has variables that store these plain
                objects. We can then use those objects in the shell as commands.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! nr = new java.lang.Integer 10
    10
    g! $nr doubleValue
    10.0
    g!</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_target">Target</h3>
            <div class="paragraph">
              <p>
                The syntax feels very natural but there is something a bit
                tricky going on. A command is executed on a <em>target</em>. A
                target is a Java object. However, Gogo searches for a match of
                the command name in several places.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_literals">Literals</h3>
            <div class="paragraph">
              <p>
                We&#8217;ve already used string literals. However, it is also
                possible to use lists and maps:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! [1 2 3] size
    3
    g! [a=1 b=2 c=3] get b
    \{ a=1, b=2, c=3 }</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                The type of the map is <code>LinkedHashMap</code>. Much of the
                original OSGi API takes a Dictionary. You can convert a literal
                map to a Dictionary as follows:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! new java.util.Hashtable [a=1 b=2 c=3]
    a                   1
    b                   2
    c                   3</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_expressions">Expressions</h3>
            <div class="paragraph">
              <p>
                So how do we access a specific header? A command like
                <code>$nr doubleValue intValue</code> cannot work because Gogo
                will see this as one command and will complain with:
                <code>Cannot coerce headers(String, String) to any of [()]</code
                >. The parentheses come to the rescue:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! nr = 10
    g! $nr doubleValue intValue
    gogo: IllegalArgumentException: Cannot coerce doublevalue(Token) to any of [()]
    g! ($nr doubleValue) intValue
    10</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                The parentheses first calculate the expression in their inner
                bowels, which then becomes available as the target object for
                the remaining command. For example,
                <code>($nr doubleValue)</code> returns a Double object, which
                subsequently becomes the target object. The
                <code>intValue</code> token is the name of the method called on
                this target object.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_backticks">Backticks</h3>
            <div class="paragraph">
              <p>
                The bash shell has this wonderful capability of executing
                commands to get an argument by placing backticks around a
                command. We can use the parentheses for the same effect, with
                the added benefit that the parentheses work recursively.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! bundle = bundle 4
    g! echo Bundle ($bundle bundleid) has name ((bundle ($bundle bundleid)) symbolicname)
    Bundle 4 has name org.apache.felix.scr</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_functions">Functions</h3>
            <div class="paragraph">
              <p>
                The Gogo shell can store commands for later execution. The
                <code>{</code> and <code>}</code> delimiters are reserved for
                that purpose. We can store these functions in objects or pass
                them as parameters. To execute a function as a command, you
                should use the name of the variable without the dollar
                (<code>'$'</code>) sign.
              </p>
            </div>
            <div class="paragraph">
              <p>
                The <code>{</code> and <code>}</code> characters are not on the
                same parsing level as for example the <code>[</code> and
                <code>]</code>. You must separate them by spaces, otherwise,
                they are part of a larger token.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! f = \{ echo Hello }
    echo Hello
    g! f
    Hello</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                You can pass arguments to the function. They are named $1..$9.
                $0 is the command name if available. The $it macro refers to
                <code>$1</code>.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! f = \{ echo $it }
    echo $1
    g! f Hello World
    Hello
    g! f = \{ echo $1 }
    g! f Hello World
    Hello</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Obviously, it is not very nice that we miss the
                <code>World</code> because we only used <code>$1</code>. There
                is a <em>magic</em> variable called <code>$args</code>. This
                variable is list that gets expanded into separate arguments. So
                we can change our function to use all the arguments when the
                function is invoked:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! f = \{ echo $args }
    echo $args
    g! f Hello         World
    Hello World</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                The <code>$args</code> list of arguments cannot be manipulated
                as a normal object as it gets expanded into its members wherever
                you use it.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! prompt={ }</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                You can store several functions together in a file and
                <code>source</code> them:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! source utils.gogo
    ...</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_repeat_and_conditionals">Repeat and Conditionals</h3>
            <div class="paragraph">
              <p>
                Gogo provides some built-in commands that use the functions to
                provide conditional and repeated execution. For example, the
                <code>each</code> command takes a collection and a function. It
                then iterates over the collection and calls the function with
                the element of the iteration.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! each [1 2 3] \{ echo -- $it --  }
    -- 1 --
    -- 2 --
    -- 3 --
    null
    null
    null</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>We can now also use the <code>if</code> command:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! l = []
    g! if \{ $l isempty } \{ echo empty } \{ echo not empty }
    empty
    g! $l add foo
    g! if \{ $l isempty } \{ echo empty } \{ echo not empty }
    not empty</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                You can negate with the <code>not</code> command, which takes a
                function:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! if { not {$l isempty}} { echo not empty } { echo empty }
    not empty</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_new">New</h3>
            <div class="paragraph">
              <p>
                You can use the <code>new</code> command to create new objects.
                The <code>new</code> command takes the name of a class and then
                the parameters for the constructor.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! object = new java.lang.Object</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_numeric_expressions">Numeric Expressions</h3>
            <div class="paragraph">
              <p>
                The Gogo shell has a convenient calculator for simple
                expressions built-in. The calculator is invoked for an
                expression that is enclosed by a <code>%(</code> and
                <code>)</code>. For example:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! echo %(21*2)
    42</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Numeric expressions allow you to evaluate simple mathematical
                and boolean expressions. It is as far as I know completely
                undocumented, the parsing is flaky, and it is completely
                unconnected to the Gogo shell. That is, you cannot even use the
                variables in the Gogo shell inside an expression However,
                sometimes it can be a lifesaver.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_exceptions">Exceptions</h3>
            <div class="paragraph">
              <p>
                You (and any code you call) can throw exceptions. The last
                exception is stored in the <code>$exception</code> variable and
                there is a built-in function <code>e</code> that shows the stack
                trace.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! throw (new java.lang.Exception Foo)
    ...
    g! $exception message
    Foo
    g! e
    java.lang.Exception: Foo
    at org.apache.felix.gogo.shell.Procedural._throw(Procedural.java:83)
    ...</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                You can also catch the exceptions with a
                <code>try</code> command.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! exception = null
    g! try { throw (new java.lang.Exception Foo) }
    g! $exception
    g!</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Of course we now silently ignore the exception, which is not a
                good idea. So we can provide a catch function that receives the
                exception as the \$it variable.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! try { throw (new java.lang.Exception Foo) } { echo ouch }
    ouch
    g!</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_telnet_daemon">Telnet Daemon</h3>
            <div class="paragraph">
              <p>
                The Eclipse console is not very user-friendly for editing the
                command line. You can start a telnet daemon.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! telnetd
    telnetd - start simple telnet server
      Usage: telnetd [-i ip] [-p port] start | stop | status
      -i --ip=INTERFACE        listen interface (default=127.0.0.1)
      -p --port=PORT           listen port (default=2019)
      -? --help                show help</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_summary_2">Summary</h3>
            <div class="paragraph">
              <p>
                In this chapter, you&#8217;ve learned the basics of the Gogo
                shell. You may wonder why so much effort is spent on learning a
                simple shell? Well, Gogo should be seen as the fabric of your
                application. We will see later that it is incredibly easy to
                provide first-class, well-documented commands in Gogo for every
                service. Having this fabric is very useful in learning and
                testing services.
              </p>
            </div>
            <div class="paragraph">
              <p>And it is fun &#8230;&#8203;</p>
            </div>
          </div>
        </div>
      </div>
      <div class="sect1">
        <h2 id="_a_new_gogo_command">A New Gogo Command</h2>
        <div class="sectionbody">
          <div class="sect2">
            <h3 id="_tldr_4">TL;DR</h3>
            <div class="paragraph">
              <p>
                Adding a new Gogo command is very easy and provides a very
                gentle introduction to programming in OSGi. In this chapter, we
                will create a <em>component</em> that registers a Gogo command
                that prints 'Hello World'. This component is then further
                enhanced to use parameters and provide helpful information.
              </p>
            </div>
            <div class="paragraph">
              <p>
                You can follow a short video at
                <a
                  href="https://bndtools.org/workspace.html#hello-world-gogo-command"
                  >bndtools.org</a
                >.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_prerequisites">Prerequisites</h3>
            <div class="paragraph">
              <p>
                This chapter assumes you have the
                <code>com.example.playground</code> project in your workspace
                and it is running the playground with the Gogo shell as was
                explained in the
                <a href="#_starting_with_osgi">Starting with OSGi</a>.
              </p>
            </div>
            <div class="paragraph">
              <p>
                In Bndtools, everything is built and deployed all the time,
                after every save. Sometimes you save and this creates errors in
                the running framework. In this case, you can just correct the
                error and continue. In general, this will correct the error.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Only when you&#8217;re lost, you should restart the framework.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_creating_a_project">Creating a Project</h3>
            <div class="paragraph">
              <p>
                You can create a new project with
                <span class="menuseq"
                  ><b class="menu">File</b>&#160;<b class="caret">&#8250;</b>
                  <b class="menuitem">Bnd OSGi Project</b></span
                >. The project will be called
                <code>com.example.playground</code> here, but you can pick your
                own name.
              </p>
            </div>
            <div class="paragraph">
              <p>
                To create a component, the easiest way is to use a little
                <code>C</code> icon at the top of the window:
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img
                  src="img/new-component-menu.png"
                  alt="new component menu"
                />
              </div>
            </div>
            <div class="paragraph">
              <p>
                The <code>OSGi Declarative Services Component</code> entry opens
                a window for a component.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img
                  src="img/new-component-dialog.png"
                  alt="new component dialog"
                />
              </div>
            </div>
            <div class="paragraph">
              <p>
                Make sure to fill in the <code>Package</code> and
                <code>Name</code> fields.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img
                  src="img/new-component-source-error.png"
                  alt="new component source error"
                />
              </div>
            </div>
            <div class="paragraph">
              <p>
                The source contains errors because we have not yet added any
                dependencies. Since the source uses the OSGi component
                annotations, the compiler cannot compile the source code. You
                can use the quick fix (The little yellow light bulb with the red
                cross) to add the OSGi annotations as a dependency.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img
                  src="img/new-component-quickfix.png"
                  alt="new component quickfix"
                />
              </div>
            </div>
            <div class="paragraph">
              <p>The source now compiles and looks like:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="keyword">package</span> <span class="namespace">com.example.playground.gogo</span>;
    <span class="keyword">import</span> <span class="include">org.osgi.service.component.annotations.Component</span>;

    <span class="annotation">@Component</span>
    <span class="directive">public</span> <span class="type">class</span> <span class="class">HelloWorld</span> {}</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Bundles add commands to the shell by registering a
                <em>service</em> with the <code>osgi.command.scope</code> and
                <code>osgi.command.function</code> service properties. The Gogo
                shell detects these service properties and will register any
                method whose name is listed in the
                <code>osgi.command.function</code> service property. Since
                services could choose the same command name, the
                <code>osgi.command.scope</code> service property can be used to
                disambiguate the command on the command-line. Just prefix a
                command with the scope and a ':' before the function name (no
                spaces).
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! scope:name
    ...</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                If a component does not implement an interface then it will
                <strong>not</strong> be registered as a <em>service</em>. Since
                Gogo is looking for services with the previously defined
                properties to register commands, it would not be able to find
                this "Hello World" command. Since this "Hello World" component
                does not implement anything, we need to make the service
                <em>explicit</em>. We use <code>Hello</code> class as the
                service type in the <code>service()</code> annotation method on
                the <code>@Component</code> annotation.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="annotation">@Component</span>(
        property = {
            <span class="string"><span class="delimiter">&quot;</span><span class="content">osgi.command.scope=hello</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">osgi.command.function=hello</span><span class="delimiter">&quot;</span></span>
        },
        service=Hello.class
    )
    <span class="directive">public</span> <span class="type">class</span> <span class="class">Hello</span> {
        <span class="directive">public</span> <span class="type">void</span> hello() {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>);
        }
    }</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_running_the_hello_world_command">
              Running the Hello World Command
            </h3>
            <div class="paragraph">
              <p>
                Select the <code>bnd.bnd</code> file, and then the
                <b class="button">Run</b> tab. You can drag the Gogo command,
                the Gogo shell bundles, as well as the
                <code>com.example.playground</code> bundle into the
                <code>Run Requirements</code> list.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img
                  src="img/gogo-command-run-requirements.png"
                  alt="gogo command run requirements"
                />
              </div>
            </div>
            <div class="paragraph">
              <p>Then click on <b class="button">Resolve</b>.</p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img
                  src="img/gogo-command-run-resolved.png"
                  alt="gogo command run resolved"
                />
              </div>
            </div>
            <div class="paragraph">
              <p>
                After you successfully resolved this, click the
                <b class="button">Update</b> button. Last, save the file and
                click on <b class="button">Debug OSGi</b>. This should start the
                Gogo shell in the Console view.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_using_the_shell">Using the Shell</h3>
            <div class="paragraph">
              <p>In the shell, we can now call the function:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! hello World
    Hello World</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                In actual systems, the number of Gogo commands tend to get very
                large. The number of commands makes it hard to ensure each
                command has a unique name. This is the reason we had to specify
                the <code>osgi.command.scope</code> service property so commands
                could be disambiguated on the command line. We can now uniquely
                identify a command if the combination of the scope and the
                function name is unique.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! hello:hello World
    Hello World</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_system_out">System.out</h3>
            <div class="paragraph">
              <p>
                In the example, we use <code>System.out</code>. This is ok, even
                if the shell is accessed via SSH or telnet. The Gogo shell
                redirects <code>System.out</code> for the duration of a command.
                However, using <code>System.out</code> makes the command only
                useful in a shell and the function can not really be called from
                other services. One of the primary goals of Gogo is to make
                commands very lightweight. The idea is that normal service
                implementations can provide commands reusing existing functions.
                Therefore, we can also just return the String, Gogo will then
                print the text.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="directive">public</span> <span class="predefined-type">String</span> hello() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>;
    }</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                After you&#8217;ve made this change and saved the source, we can
                try it in the shell immediately; there is no need to restart the
                framework. Bndtools will automatically update any changed
                bundles. (Not restarting the framework is sometimes hard to
                unlearn.)
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! hello
    Hello World</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_arguments">Arguments</h3>
            <div class="paragraph">
              <p>
                Commands can also take parameters by declaring them in the
                prototype. For example, we can provide a name that is welcomed.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="directive">public</span> <span class="predefined-type">String</span> hello(<span class="predefined-type">String</span> name) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + name;
    }</code></pre>
              </div>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! hello peter
    Hello peter</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Parameters can use any type they want. Gogo will attempt to
                coerce the given command to the proper types. For example, we
                could add a <code>boolean</code> argument to upper case the
                result:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="directive">public</span> <span class="type">int</span> hello(<span class="type">boolean</span> uppercase, <span class="predefined-type">String</span> name) {
        <span class="predefined-type">String</span> msg = <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + name;
        <span class="keyword">return</span> uppercase ? msg.toUpperCase() : msg;
    }</code></pre>
              </div>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! hello true peter
    HELLO PETER</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_flags">Flags</h3>
            <div class="paragraph">
              <p>
                Linux shell commands have a convention to provide
                <em>flags</em>. Specifying, for example, <code>-a</code> for the
                <code>ls</code> command lists <em>all</em> files, including the
                <code>.</code> and <code>..</code> files. You can mark a
                parameter with the <code>@Parameter</code> annotation to provide
                a flag.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="directive">public</span> <span class="predefined-type">String</span> hello(
        <span class="annotation">@Parameter</span>(
                names={<span class="string"><span class="delimiter">&quot;</span><span class="content">-u</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--uppercase</span><span class="delimiter">&quot;</span></span>},
                absentValue=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>,
                presentValue=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>)
        <span class="type">boolean</span> uppercase,
        <span class="predefined-type">String</span> name) {
        <span class="predefined-type">String</span> msg = <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + name;
        <span class="keyword">return</span> uppercase ? msg.toUpperCase() : msg;
    }</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                The previous code will not compile because we&#8217;re missing
                the bundle that provides the <code>@Parameter</code> annotation.
                You can add the following import line and then use the Quick Fix
                to add the <code>org.apache.felix.gogo.runtime</code> bundle to
                the <em>build path</em>.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="keyword">import</span> <span class="include">org.apache.felix.service.command.annotations.Parameter</span>;</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                The <code>names</code> annotation field specifies an array of
                names that <em>name</em> the flag. In this case, we support the
                common short form of a flag (<code>-u</code>) and the long-form
                (<code>--uppercase</code>). The
                <code>absentValue</code> annotation method defines what value is
                assigned to the parameter <code>uppercase</code> when none of
                the names are used in the command. The
                <code>presentValue</code> specifies the value to use when one of
                the names is used in the command. The annotation fields are
                strings but Gogo will convert them to the field&#8217;s type. In
                this example, the <code>absentValue</code> is
                <code>"false"</code> but will be converted to the boolean
                <code>false</code>.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Since the <code>uppercase</code> is now a flag, we do not need
                to specify a boolean anymore. And since it is a flag, even the
                <code>-u</code> or <code>--uppercase</code> identifier is
                optional, if this identifier is absent Gogo will use
                <code>false</code>.
              </p>
            </div>
            <div class="paragraph">
              <p>So let&#8217;s try it out:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! hello peter
    Hello Peter
    g! hello -u peter
    HELLO PETER</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Notice that annotated parameters, like <code>uppercase</code>,
                must come <em>before</em> any unannotated parameters.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_optional_parameters">Optional Parameters</h3>
            <div class="paragraph">
              <p>
                An <em>option</em> is a <em>named</em> parameter. Using the
                <code>@Parameter</code> annotation, we can turn a parameter in
                an option by specifying a set of <em>names</em> and a value when
                these names are absent. The <code>absentValue</code> annotation
                method can provide this value. There is no need to set the
                <code>presentValue</code> annotation method because we use the
                actual value given on the command line.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="directive">public</span> <span class="predefined-type">String</span> hello(
        <span class="annotation">@Parameter</span>(
            absentValue=<span class="string"><span class="delimiter">&quot;</span><span class="content">World</span><span class="delimiter">&quot;</span></span>,
            names={<span class="string"><span class="delimiter">&quot;</span><span class="content">-n</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">--name</span><span class="delimiter">&quot;</span></span>})
            <span class="predefined-type">String</span> name
        ) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + name;
    }</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Since we have an <code>absentValue</code>, we do not need the
                value to be specified on the command line. So we can call the
                command with and without a parameter.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">    g! hello
    Hello World
    g! hello -n OSGi
    Hello OSGi
    g! hello --name OSGi
    Hello OSGi</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_adding_help">Adding Help</h3>
            <div class="paragraph">
              <p>
                Gogo provides a <code>help</code> command that works out of the
                box:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="CodeRay highlight"><code data-lang="bnd">    g! help
    gogo:type
    gogo:until
    hello:hello
    scr:config
    ...
    scr:disable
    g! help hello
    hello
        scope: hello</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                We can add a <code>@Descriptor</code> annotations to the
                component to assist the help function. If you import:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="keyword">import</span> <span class="include">org.apache.felix.service.command.Descriptor</span>;</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>And add the annotation to the method:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="annotation">@Descriptor</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Friendly welcome</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> hello() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>;
    }</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>Then the output of the help command has changed:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">    g! help hello
    hello - Friendly welcome
        scope: hello</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                You can also apply the <code>@Descriptor</code> annotation on
                the parameters.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="annotation">@Descriptor</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Friendly welcome command</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> hello(
        <span class="annotation">@Parameter</span>(
            absentValue=<span class="string"><span class="delimiter">&quot;</span><span class="content">World</span><span class="delimiter">&quot;</span></span>,
            names={<span class="string"><span class="delimiter">&quot;</span><span class="content">-n</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">--name</span><span class="delimiter">&quot;</span></span>})
            <span class="annotation">@Descriptor</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Name to welcome</span><span class="delimiter">&quot;</span></span>)
            <span class="predefined-type">String</span> name
        ) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + name;
    }</code></pre>
              </div>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">    g! help hello
    hello - Friendly welcome command
    scope: hello
    options:
        -n, --name   Name to welcome [optional]</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_property_annotation">Property Annotation</h3>
            <div class="paragraph">
              <p>
                The component properties <code>osgi.command.scope</code> and
                <code>osgi.command.function</code> are constructed from strings.
                This is an error-prone programming pattern. We used this
                error-prone patter to make more clear what was going on beneath
                the covers; it also allowed us to get started without importing
                the Gogo runtime bundle. However, the
                <code>org.apache.felix.runtime</code> bundle, that we use for
                the <code>@Descriptor</code> and
                <code>@Parameter</code> annotations, also contains an annotation
                to add service properties: <code>@GogoCommand</code>. This
                annotation cleans up the component by defining the Gogo service
                properties via a simple annotation.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="annotation">@GogoCommand</span>(scope=<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, function=<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@Component</span>(service=<span class="predefined-type">Object</span>.class)
    <span class="directive">public</span> <span class="type">class</span> <span class="class">HelloWorld</span> { ... }</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_summary_3">Summary</h3>
            <div class="paragraph">
              <p>
                In this chapter, we created a Gogo command with the OSGi
                Declarative Services standard. We used the playground project to
                interactively change the initial simple command into a fully
                documented command with a flag and parameters.
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="sect1">
        <h2 id="_api_bundle">API Bundle</h2>
        <div class="sectionbody">
          <div class="sect2">
            <h3 id="_tldr_5">TL;DR</h3>
            <div class="paragraph">
              <p>
                OSGi&#8217;s primary innovation is the
                <em>service registry</em>. Services are used to decouple
                components/modules from each other. In OSGi, modules depend on
                service <em>contracts/APIs</em>, not on other modules as is the
                custom in classical module systems. Services require a
                <em>contract</em> or <em>API</em>. An OSGi API is a bit like a
                screenplay for a movie, it describes how the different
                <em>actors</em> (the service implementations) must play their
                <em>role</em> (the service interfaces). A contract is
                represented by an <em>exported</em> package in OSGi that holds
                the classes, interfaces, and documentation.
              </p>
            </div>
            <div class="paragraph">
              <p>
                In this section, we are going to create an API for a simple
                expression evaluator. It will teach you how to create an API
                project, how to name a project, and how to navigate around
                inside the project. We will also explain how to export and
                version the API package.
              </p>
            </div>
            <div class="paragraph">
              <p>
                You can follow a short video at
                <a
                  href="https://bndtools.org/workspace.html#api&#8212;&#8203;provider-project"
                  >API &amp; Provider Project</a
                >.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_creating_an_api_project">Creating an API Project</h3>
            <div class="paragraph">
              <p>
                Assume, we noticed that in several projects developers evaluated
                expressions from a string like <code>5*2</code>. They used
                different libraries, had different syntaxes, and they had
                different ways of adding custom functions. To address these
                issues, we created a story that there should be a service that
                could evaluate these types of expressions.
              </p>
            </div>
            <div class="paragraph">
              <p>So let&#8217;s create an API project.</p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>
                    Create a project with
                    <span class="menuseq"
                      ><b class="menu">File</b>&#160;<b class="caret"
                        >&#8250;</b
                      >
                      <b class="submenu">New</b>&#160;<b class="caret"
                        >&#8250;</b
                      >
                      <b class="menuitem">Bnd OSGi Project</b></span
                    >. Name the project:
                  </p>
                </li>
              </ul>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">    com.example.eval.api</code></pre>
              </div>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>Use the <code>API</code> template.</p>
                </li>
                <li>
                  <p>
                    This template will ask for the name of the service
                    interface. Use <code>Eval</code> for this exercise.
                  </p>
                </li>
                <li>
                  <p>
                    Uncheck the 'Create module-info.java file' option if it is
                    enabled. (This happens on Java 9 and later; it is
                    recommended to use Java 8.)
                  </p>
                </li>
                <li>
                  <p><b class="button">Finish</b></p>
                </li>
                <li>
                  <p>
                    Update the given <code>Eval</code> interface in the package
                    <code>com.example.eval.api</code> to:
                  </p>
                </li>
              </ul>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="keyword">package</span> <span class="namespace">com.example.eval.api</span>;
    <span class="directive">public</span> <span class="type">interface</span> <span class="class">Eval</span> {
        <span class="type">double</span> eval(<span class="predefined-type">String</span> expression) <span class="directive">throws</span> <span class="exception">Exception</span>;
    }</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_naming">Naming</h3>
            <div class="paragraph">
              <p>
                The name of this API project was not chosen at random. Over the
                years, a common pattern was established as a best practice to
                name projects.
              </p>
            </div>
            <div class="literalblock">
              <div class="content">
                <pre>
&lt;domain&gt;.&lt;workspace&gt;.&lt;api&gt;[.&lt;provider&gt;].&lt;ext&gt;</pre
                >
              </div>
            </div>
            <table class="tableblock frame-all grid-all stretch">
              <colgroup>
                <col style="width: 33.3333%;" />
                <col style="width: 33.3333%;" />
                <col style="width: 33.3334%;" />
              </colgroup>
              <thead>
                <tr>
                  <th class="tableblock halign-left valign-top">Part</th>
                  <th class="tableblock halign-left valign-top">Example</th>
                  <th class="tableblock halign-left valign-top">Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock">domain</p>
                  </td>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock"><code>com.example</code></p>
                  </td>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock">
                      The organization&#8217;s domain name as is common in Java
                    </p>
                  </td>
                </tr>
                <tr>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock">workspace</p>
                  </td>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock"><code>prime</code></p>
                  </td>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock">
                      A unique name in the organization for the workspace/system
                    </p>
                  </td>
                </tr>
                <tr>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock">api</p>
                  </td>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock"><code>eval</code></p>
                  </td>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock">The API name</p>
                  </td>
                </tr>
                <tr>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock">provider</p>
                  </td>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock"><code>simple</code></p>
                  </td>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock">
                      A short name of the typical implementation aspect of the
                      API
                    </p>
                  </td>
                </tr>
                <tr>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock">ext</p>
                  </td>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock"><code>api</code></p>
                  </td>
                  <td class="tableblock halign-left valign-top">
                    <p class="tableblock">
                      One of the common extensions like <code>api</code>,
                      <code>provider</code>, etc.
                    </p>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="paragraph">
              <p>
                The advantage of this naming scheme is that it sorts rather
                well. In a sorted list it puts related projects close together.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_building">Building</h3>
            <div class="paragraph">
              <p>
                Bndtools will <em>immediately</em> build the bundle directly
                after any change is saved, hence there is never a need to worry
                if projects have already been built. Any dependencies are also
                always rebuilt automatically.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Therefore, in the <code>target</code> directory of the
                <code>com.example.eval.api</code> project you can now find the
                bundle for this project. You can double click on this
                <code>JAR</code> file which will open a window with its
                contents. This window selects the <em>manifest</em> of the
                bundle. The manifest contains metadata for OSGi:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="manifest">    Manifest-Version: 1.0
    Bnd-LastModified: 1578407040731
    Bundle-ManifestVersion: 2
    Bundle-Name: com.example.eval.api
    Bundle-SymbolicName: com.example.eval.api
    Bundle-Version: 1.0.0.202001071424
    Created-By: 1.8.0_144 (Oracle Corporation)
    Export-Package: com.example.eval.api;version=&quot;1.0.0&quot;
    Require-Capability: osgi.ee;filter:=&quot;(&amp;(osgi.ee=JavaSE)(version=1.8))&quot;
    Tool: Bnd-5.0.0.201912100922-SNAPSHOT</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_service_api_package">Service API Package</h3>
            <div class="paragraph">
              <p>
                Although a service is registered with a single interface, we
                should define a service in a separate <em>package</em>. The
                reason is that in anything but the most trivial services you
                will need support objects and multiple collaborating service
                interfaces. A service API is like the scenario for a role play,
                you have different actors (interfaces) and stage props
                (objects).
              </p>
            </div>
            <div class="paragraph">
              <p>
                Therefore when we talk about a service API, we always refer to a
                package, although every single service is implemented in a
                single interface.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_exporting">Exporting</h3>
            <div class="paragraph">
              <p>
                The <code>com.example.eval.api</code> package is
                <em>exported</em> in the manifest, looking at the
                <code>Export-Package</code> header. An exported package can be
                used by other bundles that <em>import</em> it. This project was
                created from the API template. It automatically exports the
                package with the API.
              </p>
            </div>
            <div class="paragraph">
              <p>
                You can export a <em>package</em> by adding an annotation to the
                <code>package-info.java</code> file in that package. This is
                already prepared for you by the template project.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="annotation">@org</span>.osgi.annotation.versioning.Version(<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@org</span>.osgi.annotation.bundle.Export
    <span class="keyword">package</span> <span class="namespace">com.example.eval.api</span>;</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                You can also see that a package is exported in the Eclipse
                Explorer. An exported package in the explorer is exported when
                it is decorated with a little green <code>+</code> icon in the
                left top.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="img/package-export.png" alt="package export" />
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_versioning">Versioning</h3>
            <div class="paragraph">
              <p>
                In OSGi, a service package must be exported so that other
                bundles can rely on being linked to a
                <em>compatible</em> service. The purpose of versioning is to
                ensure that bundles that are compiled against an API are
                compatible with the providers of that API. Semantic versions
                provide the information for OSGi (and bnd) to ensure the
                validity of the system.
              </p>
            </div>
            <div class="paragraph">
              <p>For this reason, an OSGi version has 3 parts:</p>
            </div>
            <div class="literalblock">
              <div class="content">
                <pre>major.minor.micro.qualifier</pre>
              </div>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>
                    <code>major</code> – A change in this part signals full
                    incompatibility,
                  </p>
                </li>
                <li>
                  <p>
                    <code>minor</code> – A change in this part indicates that
                    <em>consumers</em> are ok but <em>providers</em> are
                    incompatible,
                  </p>
                </li>
                <li>
                  <p><code>micro</code> – A compatible change.</p>
                </li>
              </ul>
            </div>
            <div class="paragraph">
              <p>
                Here, the API package is versioned with a version of
                <code>1.0.0</code> with the
                <code>@org.osgi.annotation.versioning.Version("1.0.0")</code>
                annotation.
              </p>
            </div>
            <div class="sect3">
              <h4 id="_showing_off">Showing Off!</h4>
              <div class="paragraph">
                <p>
                  If you change the
                  <code>@org.osgi.annotation.versioning.Version("1.0.0")</code>
                  in the <code>package-info.java</code> file to version
                  <code>1.2.3</code> and then look at the manifest by clicking
                  on the <code>target/com.example.eval.api.jar</code> file. You
                  will see that the <code>Export-Package</code> header is
                  immediately updated.
                </p>
              </div>
              <div class="paragraph">
                <p>
                  If you remove the
                  <code>@org.osgi.annotation.bundle.Export</code> in
                  <code>package-info.java</code> then the <code>+</code> icon is
                  removed from the package and the manifest will show:
                </p>
              </div>
              <div class="literalblock">
                <div class="content">
                  <pre>
Private-Package: com.example.eval.api;version="1.2.3"</pre
                  >
                </div>
              </div>
              <div class="paragraph">
                <p>
                  Having an <code>@Version</code> annotation on a non-exported
                  package is of course not recommended. Private packages should
                  not have versions.
                </p>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_provider_type">Provider Type</h3>
            <div class="paragraph">
              <p>
                The Eval source also shows a
                <code>@ProviderType</code> annotation. When your dependency
                model is based on contracts it turns out that you have two
                different kinds of dependencies on contracts. The provider is
                the bundle that is primarily responsible for the contract and
                the consumer is the one depends on the contract to provide it
                some utility. The annotations <code>@ProviderType</code> and
                <code>@ConsumerType</code> mark an interface&#8217;s expected
                implementor: either the provider or the consumer. The words
                <em>consumer</em> and <em>provider</em> are used because both a
                provider as well as a consumer can be an <em>implementer</em> or
                a <em>user</em> of a service interface.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Confused? Experience shows this is a difficult topic. In
                general, bnd will do the right thing.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_summary_4">Summary</h3>
            <div class="paragraph">
              <p>
                We&#8217;ve now created an API project that exports a package
                with one interface. The project has no dependencies.
              </p>
            </div>
            <div class="paragraph">
              <p>
                In the next chapter, we&#8217;ll create a simple
                <em>provider</em> of the <code>com.example.eval.api</code> API.
                :experimental: true :icons: font
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="sect1">
        <h2 id="_provider_bundle">Provider Bundle</h2>
        <div class="sectionbody">
          <div class="sect2">
            <h3 id="_tldr_6">TL;DR</h3>
            <div class="paragraph">
              <p>
                In this section, we create a <em>provider</em> for the Eval API.
                We will show how to add dependencies to a project and explain
                the <code>-buildpath</code>.
              </p>
            </div>
            <div class="paragraph">
              <p>
                You can follow a short video at
                <a
                  href="https://bndtools.org/workspace.html#api&#8212;&#8203;provider-project"
                  >Provider Project</a
                >. You may also check out
                <a
                  href="https://bndtools.org/workspace.html#external-dependencies"
                  >External Dependencies</a
                >.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_providing_an_api">Providing an API</h3>
            <div class="paragraph">
              <p>
                In the previous section, we created an <em>API</em> project for
                a simple <em>expression evaluator</em>. In this chapter, we
                create another project that provides an implementation for the
                Eval API. A bundle that has as its sole reason to provide an API
                is called to be a <em>provider</em> bundle. Any service contract
                can have many different providers although in general only one
                is selected for the runtime. For example, there are providers
                for the OSGi <code>org.osgi.service.event</code> API from
                Eclipse, Apache Felix, and Knopflerfish. You can
                <em>compile</em> against the OSGi API and then select one of the
                providers in your runtime.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_create_a_provider_project">Create a Provider Project</h3>
            <div class="paragraph">
              <p>
                Create a project called
                <code>com.example.eval.simple.provider</code>. The
                <code>simple</code> part of the name allows us the freedom to
                have alternative providers of the
                <code>com.example.eval.api</code> service API. For example, we
                will later add a provider that uses a popular expression library
                from Maven Central.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Using the <code>Provider Bundle</code> template, you will be
                asked for the name for a component. Use
                <code>EvalImpl</code> for this name.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_create_a_component">Create a Component</h3>
            <div class="paragraph">
              <p>
                The template has already provided a component for you. The
                EvalImpl class should give the following source code:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="keyword">package</span> <span class="namespace">com.example.eval.provider</span>;
    <span class="keyword">import</span> <span class="include">org.osgi.service.component.annotations.Component</span>;

    <span class="annotation">@Component</span>
    <span class="directive">public</span> <span class="type">class</span> <span class="class">EvalImpl</span> {    }</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_dependencies">Dependencies</h3>
            <div class="paragraph">
              <p>
                The next step is to implement the <code>Eval</code> interface
                from our API project. It is time anyway to dive deeper into how
                bnd handles the <em>build path</em>.
              </p>
            </div>
            <div class="paragraph">
              <p>
                To compile the code, the compiler needs to have a
                <em>build path</em>, a set of bundles that provide the APIs to
                compile against. This build path is defined in the
                <code>bnd.bnd</code> file in every project.
              </p>
            </div>
            <div class="paragraph">
              <p>
                If you open this <code>bnd.bnd</code> file and select the
                <b class="button">Source</b> tab you see it is currently empty.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_repositories">Repositories</h3>
            <div class="paragraph">
              <p>
                The <em>workspace</em> has several <em>repositories</em>,
                repositories are a collection of bundles. If you look at the
                bottom-left of the screen (in the Bndtools perspective) you can
                see the current repositories of the workspace.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="img/repositories.png" alt="repositories" />
              </div>
            </div>
            <div class="paragraph">
              <p>
                In the current workspace there are three repositories
                configured:
              </p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>Workspace – Contains all the bundles from the projects</p>
                </li>
                <li>
                  <p>
                    Build – Bundles intended to be used in the build only. E.g.
                    API, test, etc.
                  </p>
                </li>
                <li>
                  <p>Runtime – Bundles for the runtime</p>
                </li>
              </ul>
            </div>
            <div class="paragraph">
              <p>
                The repositories are defined in the <code>cnf</code> project,
                look in the <code>ext</code> directory for their definition
                files. We will not discuss the details here. However, bnd has an
                extremely flexible repository model and supports out of the box
                Maven repositories, P2 repositories /target platforms, and OSGi
                XML repositories.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_build_path">Build Path</h3>
            <div class="paragraph">
              <p>
                The build path dependencies of a bnd project are defined in the
                <code>bnd.bnd</code> file. We can, therefore, control the build
                path through the <em>build path editor</em>. Double click on the
                <code>bnd.bnd</code> file and select the
                <b class="button">Build</b> tab.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="img/buildpath-editor.png" alt="buildpath editor" />
              </div>
            </div>
            <div class="paragraph">
              <p>
                As you can see, the
                <code>org.osgi.component.annotations</code> bundle is already
                listed. To add another dependency, click on the
                <b class="button">+</b> and then <em>swipe</em> the
                <code>com.example.eval.api</code> bundle from the left to the
                right (or click the <b class="button">Add</b> if you&#8217;re
                not into swiping). If you&#8217;re looking for a specific bundle
                then you can filter them by symbolic name. Type the name in the
                filter text box to limit the entries that match.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="img/buildpath-add.png" alt="buildpath add" />
              </div>
            </div>
            <div class="paragraph">
              <p>
                Press <b class="button">Finish</b> and save the
                <code>bnd.bnd</code> file because otherwise there is no effect.
              </p>
            </div>
            <div class="paragraph">
              <p>
                When you save this file, Eclipse will add all bundles on the
                build path to its internal <em>compiler path</em>. If you look
                in the Bndtools Explorer, open the project, then you should see
                an item called <code>Bnd Bundle Path</code>. You can open this
                entry and beneath it, you will see all build path entries. Each
                entry is also possible to open, it allows you to inspect the
                classes that are contributed to the compiler.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img
                  src="img/buildpath-container.png"
                  alt="buildpath container"
                />
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_implementing_eval">Implementing Eval</h3>
            <div class="paragraph">
              <p>
                You can now go back to the <code>EvalImpl</code> class and
                implement the <code>Eval</code> interface.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="annotation">@Component</span>
    <span class="directive">public</span> <span class="type">class</span> <span class="class">EvalImpl</span> <span class="directive">implements</span> Eval {}</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Just select the <code>Eval</code> name (which is red underlined)
                and click <code>Control-1</code>, select
                <code>Import 'Eval' (com.example.eval.api)</code>. This will
                take care of the import. Don&#8217;t forget to save it!
              </p>
            </div>
            <div class="paragraph">
              <p>
                Alas, we got rid of the import error but in place of this error,
                we now get a red underlined <code>EvalImpl</code> class. The
                problem is that we need to provide the <code>eval</code> method,
                as prescribed by the Eval interface that it now implements.
                Let&#8217;s keep it as simple as possible while still doing
                something not utterly useless:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="annotation">@Component</span>
    <span class="directive">public</span> <span class="type">class</span> <span class="class">EvalImpl</span> <span class="directive">implements</span> Eval {
        <span class="predefined-type">Pattern</span> EXPR = <span class="predefined-type">Pattern</span>.compile( <span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">s*(?&lt;left&gt;</span><span class="char">\\</span><span class="content">d+)</span><span class="char">\\</span><span class="content">s*(?&lt;op&gt;</span><span class="char">\\</span><span class="content">+|-)</span><span class="char">\\</span><span class="content">s*(?&lt;right&gt;</span><span class="char">\\</span><span class="content">d+)</span><span class="char">\\</span><span class="content">s*</span><span class="delimiter">&quot;</span></span>);
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">double</span> eval(<span class="predefined-type">String</span> expression) <span class="directive">throws</span> <span class="exception">Exception</span> {
            <span class="predefined-type">Matcher</span> m = EXPR.matcher(expression);
            <span class="keyword">if</span> ( !m.matches())
                <span class="keyword">return</span> <span class="predefined-type">Double</span>.NaN;
            <span class="type">double</span> left = <span class="predefined-type">Double</span>.valueOf( m.group(<span class="string"><span class="delimiter">&quot;</span><span class="content">left</span><span class="delimiter">&quot;</span></span>));
            <span class="type">double</span> right = <span class="predefined-type">Double</span>.valueOf( m.group(<span class="string"><span class="delimiter">&quot;</span><span class="content">right</span><span class="delimiter">&quot;</span></span>));
            <span class="keyword">switch</span>( m.group(<span class="string"><span class="delimiter">&quot;</span><span class="content">op</span><span class="delimiter">&quot;</span></span>)) {
              <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">+</span><span class="delimiter">&quot;</span></span>: <span class="keyword">return</span> left + right;
              <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-</span><span class="delimiter">&quot;</span></span>: <span class="keyword">return</span> left - right;
            }
            <span class="keyword">return</span> <span class="predefined-type">Double</span>.NaN;
        }
    }</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Ok, ok, calling it simple might still give it too much credit
                but we&#8217;re not here to learn parsing. At least it has
                (some) error handling! Notice that we can only handle trivial
                additions and subtractions of constants.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_imports">Imports</h3>
            <div class="paragraph">
              <p>
                It is about time now to take a look at what our bundle really
                looks like. Double click on the
                <code>target/com.example.eval.simple.provider.jar</code> file.
                This opens the <em>JAR Editor</em>. Select the
                <b class="button">Print</b> tab, look at the
                <code>IMPEXP</code> section.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="CodeRay highlight"><code>    [IMPEXP]
    Import-Package
    com.example.eval.api                   {version=[1.0,1.1)}</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                The reason we import the minor range (<code>[1.0,1.1)</code>) is
                that the <code>Eval</code> interface was annotated with the
                <code>@ProviderType</code> and we do implement this interface.
                Because we implement a provider interface, bnd assumes this
                bundle is a <em>provider</em> of the
                <code>com.example.eval.api</code> API and therefore must import
                the package with a minor range. If the contract changes in any
                way, we need to make a new version of this provider bundle.
              </p>
            </div>
            <div class="admonitionblock note">
              <table>
                <tr>
                  <td class="icon">
                    <div class="title">Note</div>
                  </td>
                  <td class="content">
                    The concepts of provider and consumer of APIs seem hard to
                    understand. Fortunately, bnd handles it all quite well.
                    Trust us. :-)
                  </td>
                </tr>
              </table>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_gogo_command">Gogo Command</h3>
            <div class="paragraph">
              <p>
                Making a service a Gogo command is a good way to
                <em>play</em> with the services that are being developed.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Add <code>org.apache.felix.gogo.runtime</code> to the
                <code>-buildpath</code> in the <code>bnd.bnd</code> file.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">    -buildpath: \
        osgi.annotation,\
        org.osgi.service.component.annotations,\
        com.example.eval.api;version=latest,\
        org.apache.felix.gogo.runtime

    -testpath: \
        osgi.enroute.junit.wrapper, \
        osgi.enroute.hamcrest.wrapper</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Then add the <code>@GogoCommand</code> annotation to the
                <code>EvalImpl</code> class.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="annotation">@GogoCommand</span>(scope=<span class="string"><span class="delimiter">&quot;</span><span class="content">simple</span><span class="delimiter">&quot;</span></span>, function={<span class="string"><span class="delimiter">&quot;</span><span class="content">eval</span><span class="delimiter">&quot;</span></span>})
    <span class="annotation">@Component</span>
    <span class="directive">public</span> <span class="type">class</span> <span class="class">EvalImpl</span> <span class="directive">implements</span> Eval {...}</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_running_in_the_playground">Running in the Playground</h3>
            <div class="paragraph">
              <p>
                Open the <code>bnd.bnd</code> file of the
                <code>com.example.playground</code> project we created in the
                starting section. Select the <b class="button">Run</b> tab. In
                this tab you can add the
                <code>com.example.eval.simple.provider</code> bundle to the
                initial requirements. You should then
                <b class="button">Resolve</b>. The calculated list of bundles
                should look something like:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">        org.apache.felix.gogo.command
        org.apache.felix.gogo.runtime
        org.apache.felix.gogo.shell
        com.example.playground
        org.apache.felix.scr
        org.osgi.util.function
        org.osgi.util.promise
        com.example.eval.api
        com.example.eval.simple.provider</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                The <em>resolver</em> that we used is the secret weapon of OSGi.
                It searches the repositories, including our own code, for
                bundles that can work together. Each bundle contains
                <em>metadata</em> that describes what requirements it has to the
                outside world and what capabilities it can provide. In the end,
                the resolver creates a set of bundles where all their
                requirements are satisfied. Or it gives up &#8230;&#8203;
              </p>
            </div>
            <div class="paragraph">
              <p>
                Notice how the resolver automatically added the
                <code>com.example.eval.api</code> bundle. It noticed that this
                was required by the
                <code>com.example.eval.simple.provider</code> bundle.
              </p>
            </div>
            <div class="paragraph">
              <p>
                You should <b class="button">Finish</b> the resolver and save
                the <code>bnd.bnd</code> file.
              </p>
            </div>
            <div class="paragraph">
              <p>
                If the framework was still running, the new bundles will
                automatically be added. We should then immediately be able to
                run the command:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! eval 1+2
    3.0</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_summary_5">Summary</h3>
            <div class="paragraph">
              <p>
                In this section, we created a provider for the
                <code>com.example.eval.api</code> API. We used the Provider
                template to create an EvalImpl component. We extended the build
                path to contain the API project and wrote a simplistic
                implementation.
              </p>
            </div>
            <div class="paragraph">
              <p>
                We then tested the implementation with a Gogo command in the
                playground.
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="sect1">
        <h2 id="_junit_testing">JUnit Testing</h2>
        <div class="sectionbody">
          <div class="sect2">
            <h3 id="_tldr_7">TL;DR</h3>
            <div class="paragraph">
              <p>
                In this section, we will create a <em>whitebox</em> JUnit test
                for our provider implementation. This test will not depend on
                OSGi. It is a goal in OSGi projects to make the components
                testable without the overhead of an OSGi framework. These JUnit
                tests are very cheap; using them extensively saves a tremendous
                amount of time in later phases of the development process. JUnit
                tests are always run before code is released and when they fail,
                they prohibit the release of the project.
              </p>
            </div>
            <div class="paragraph">
              <p>
                JUnit tests can also contain <em>launchpad</em>, a bnd library
                to test with an OSGi framework present.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Testing is one of those chores a developer has to do, not as
                much fun as some deep algorithmic code. However, it is likely
                one of the most effective ways to spend your time.
              </p>
            </div>
            <div class="paragraph">
              <p>
                This section is not needed if you&#8217;re familiar with JUnit
                and launchpad.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_junit">JUnit</h3>
            <div class="paragraph">
              <p>
                A provider should always have <strong>unit</strong> tests. Unit
                tests are <strong>white</strong> box tests. The test knows about
                the implementation details and it can even see aspects of the
                components that are not part of the public API.
              </p>
            </div>
            <div class="paragraph">
              <p>
                The <code>Provider Bundle</code> template provided us with a
                template for the test class: <code>EvalImplTest</code> in the
                <code>test</code> folder. This class is set up to run a JUnit 4
                test:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="keyword">package</span> <span class="namespace">com.example.eval.simple.provider</span>;

    <span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.Assert.assertNotNull</span>;
    <span class="keyword">import</span> <span class="include">org.junit.Test</span>;
    <span class="keyword">import</span> <span class="include">com.example.eval.simple.provider.EvalImpl</span>;

    <span class="directive">public</span> <span class="type">class</span> <span class="class">EvalImplTest</span> {
        <span class="annotation">@Test</span>
        <span class="directive">public</span> <span class="type">void</span> simple() {
            EvalImpl impl = <span class="keyword">new</span> EvalImpl();
            assertNotNull(impl);
        }
    }</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                The <code>test</code> folder is special. No code from the
                <code>test</code> folder should not end up in our bundle, nor
                should any of its dependencies be counted as imports. For this
                reason, the <code>test</code> folder is compiled with the
                <code>-buildpath</code> and the, <code>-testpath</code>. bnd
                guarantees that no test code, nor any of its dependencies in the
                <code>-testpath</code>, can accidentally end up in the bundle.
              </p>
            </div>
            <div class="paragraph">
              <p>
                The template has already set up the <code>-testpath</code> with
                the JUnit dependencies. You can click on the
                <code>bnd.bnd</code> in the
                <code>com.example.eval.simple.provider</code> project, select
                the <b class="button">Source</b> tab:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="CodeRay highlight"><code data-lang="bnd">    #
    # com.example.eval.simple.provider PROVIDER BUNDLE
    #

    -buildpath: \
        osgi.annotation,\
        org.osgi.service.component.annotations,\
        com.example.eval.api;version=latest


    -testpath: \
        osgi.enroute.junit.wrapper, \
        osgi.enroute.hamcrest.wrapper</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>So let&#8217;s evaluate a simple expression:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="keyword">package</span> <span class="namespace">com.acme.prime.eval.provider</span>;
    <span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.Assert.assertEquals</span>;

    <span class="directive">public</span> <span class="type">class</span> <span class="class">EvalImplTest</span> {
        <span class="annotation">@Test</span>
        <span class="directive">public</span> <span class="type">void</span> testSimple() <span class="directive">throws</span> <span class="exception">Exception</span> {
            EvalImpl t = <span class="keyword">new</span> EvalImpl();
            assertEquals( <span class="float">3.0</span>,  t.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">1 + 2</span><span class="delimiter">&quot;</span></span>), <span class="float">0.0001D</span>);
        }
    }</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                You can run the test by selecting the class name
                (<code>EvalImplTest</code>) or the method name (testSimple),
                call up the context menu, and select
                <span class="menuseq"
                  ><b class="menu">RunAs</b>&#160;<b class="caret">&#8250;</b>
                  <b class="menuitem">JUnit Test</b></span
                >. Do not select
                <span class="menuseq"
                  ><b class="menu">RunAs</b>&#160;<b class="caret">&#8250;</b>
                  <b class="menuitem">Bnd OSGi Test Launcher (JUnit)</b></span
                >
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="img/junit-result.png" alt="junit result" />
              </div>
            </div>
            <div class="paragraph">
              <p>
                To run JUnit tests you can select the project in the explorer,
                the <code>test</code> folder, a package, a class, or a method
                and call up the context menu and then
                <span class="menuseq"
                  ><b class="menu">RunAs</b>&#160;<b class="caret">&#8250;</b>
                  <b class="menuitem">JUnit Test</b></span
                >. It will then run all tests selected beneath that level.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_debugging">Debugging</h3>
            <div class="paragraph">
              <p>
                Since most code does not run the first time, we need to debug as
                well. You can set a breakpoint by double-clicking in the margin
                where you want the breakpoint to happen. A blue dot then
                appears. Just select the test method you want to run and do
                <span class="menuseq"
                  ><b class="menu">Debug As</b>&#160;<b class="caret"
                    >&#8250;</b
                  >
                  <b class="menuitem">JUnit Test</b></span
                >.
              </p>
            </div>
            <div class="paragraph">
              <p>
                The JUnit pane has many buttons that allow you to rerun tests,
                an incredibly powerful tool.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_launchpad">Launchpad</h3>
            <div class="paragraph">
              <p>
                Launchpad is bnd library that makes it easy to test OSGi code in
                a normal plain JUnit environment. To use Launchpad, make sure to
                add the following entries to your <code>-testpath</code> in the
                bnd.bnd file:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">    -testpath:  \
        biz.aQute.launchpad,\
        org.osgi.framework,\
        slf4j.api,\
        slf4j.simple,\
        org.osgi.resource,\
        org.osgi.dto,\
        org.osgi.util.tracker,\
        com.example.eval.api, \
        osgi.enroute.junit.wrapper, \
        osgi.enroute.hamcrest.wrapper</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>Also add the following runbundles:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">    -runbundles: \
        com.example.eval.api;version=snapshot,\
        org.apache.felix.scr,\
        org.osgi.util.function,\
        org.osgi.util.promise,\
        org.apache.felix.gogo.command,\
        org.apache.felix.gogo.runtime,\
        org.apache.felix.gogo.shell</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>Change your test class to the following:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="annotation">@RunWith</span>(LaunchpadRunner.class)
    <span class="directive">public</span> <span class="type">class</span> <span class="class">EvalImplTest</span> {
        <span class="directive">static</span> LaunchpadBuilder builder = <span class="keyword">new</span> LaunchpadBuilder().bndrun(<span class="string"><span class="delimiter">&quot;</span><span class="content">bnd.bnd</span><span class="delimiter">&quot;</span></span>);
        <span class="annotation">@Service</span>(service = Eval.class)
        EvalImpl eval;
        <span class="annotation">@Service</span>
        Launchpad launchpad;
        <span class="annotation">@Test</span>
        <span class="directive">public</span> <span class="type">void</span> simple() <span class="directive">throws</span> InvalidSyntaxException {
            assertNotNull(eval);
            launchpad.report();
        }
    }</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_making_bundles">Making Bundles</h3>
            <div class="paragraph">
              <p>
                The Launchpad object contains a special <em>bundle builder</em>.
                It provides the same capabilities that bnd already has when it
                creates bundles. You can use all the facilities that you can use
                in the <code>bnd.bnd</code> file: Export-Package,
                Import-Package, <code>-includeresource</code>, etc.
              </p>
            </div>
            <div class="paragraph">
              <p>
                The following example shows how to create a bundle with a
                special header.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> bundles() <span class="directive">throws</span> <span class="exception">Exception</span> {
            Bundle b = launchpad.bundle()
                .header(<span class="string"><span class="delimiter">&quot;</span><span class="content">FooBar</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>)
                .install();
            <span class="predefined-type">String</span> string = b.getHeaders()
                .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">FooBar</span><span class="delimiter">&quot;</span></span>);
            assertTrue(string.equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>));
    }</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_interaction_with_services">Interaction with Services</h3>
            <div class="paragraph">
              <p>
                Clearly, the best part of Launchpad is that you can actually use
                real services and do not have to mock them up. Many a test seems
                to mostly test their mocks.
              </p>
            </div>
            <div class="paragraph">
              <p>
                With Launchpad, a real framework is running. You can inject
                services or register services.
              </p>
            </div>
            <div class="paragraph">
              <p>
                In the following example, we register a service
                <code>Foo</code> and then verify if we can get it. We then
                unregister the service and see that it no longer exists.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="type">interface</span> <span class="class">Foo</span> {}
    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> services() <span class="directive">throws</span> <span class="exception">Exception</span> {
        ServiceRegistration&lt;Foo&gt; register = launchpad.register(Foo.class, <span class="keyword">new</span> Foo() {
        });
        Optional&lt;Foo&gt; s = launchpad.waitForService(Foo.class, <span class="integer">100</span>);
        assertTrue(s.isPresent());
        register.unregister();
        s = launchpad.waitForService(Foo.class, <span class="integer">100</span>);
        assertFalse(s.isPresent());
    }</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                The <code>waitForService</code> methods take a timeout in
                milliseconds. Their purpose is to provide some leeway during
                startup for the system to settle. If a service is expected to be
                registered then the <code>getService()</code> methods can be
                used.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_injection">Injection</h3>
            <div class="paragraph">
              <p>
                You can declare fields with the <code>@Service</code> annotation
                and they are injected. However, not all tests use the same types
                so you can also injection manually. The injection can also
                happen as often as you want.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> inject() <span class="directive">throws</span> <span class="exception">Exception</span> {
        ServiceRegistration&lt;Foo&gt; register = launchpad.register(Foo.class, <span class="keyword">new</span> Foo() {
        });
        <span class="type">class</span> <span class="class">I</span> {
            <span class="annotation">@Service</span>
            Foo             foo;
            <span class="annotation">@Service</span>
            Bundle          bundles<span class="type">[]</span>;
            <span class="annotation">@Service</span>
            BundleContext   context;
        }
        I inject = <span class="keyword">new</span> I();
        launchpad.inject(inject);
        assertTrue(inject.bundles.length != <span class="integer">0</span>);
        register.unregister();
    }</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_hello_world">Hello World</h3>
            <div class="paragraph">
              <p>
                Although the of a Bundle-Activator is not recommended, they are
                singletons, a Bundle-Activator can be very useful in test cases.
                With Launchpad it is not necessary to make a separate bundle, we
                can make a bundle with an inner class as an activator.
              </p>
            </div>
            <div class="paragraph">
              <p>
                We first define the Bundle Activator as a static public inner
                class of the test class:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Activator</span> <span class="directive">implements</span> BundleActivator {
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> start(BundleContext context) <span class="directive">throws</span> <span class="exception">Exception</span> {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> stop(BundleContext context) <span class="directive">throws</span> <span class="exception">Exception</span> {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Goodbye World</span><span class="delimiter">&quot;</span></span>);
        }
    }</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                The Launchpad class contains a special <em>Bundle builder</em>.
                This bundle builder is based on bnd and can do everything that
                bnd can do in a <code>bnd.bnd</code> file. In this case, we add
                the Bundle Activator and start it.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> activator() <span class="directive">throws</span> <span class="exception">Exception</span> {
            Bundle start = launchpad.bundle()
                .bundleActivator(<span class="predefined-type">Activator</span>.class)
                .start();
    }</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>When the test is run the output is:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="CodeRay highlight"><code>    Hello World
    Goodbye World</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_tidbits">Tidbits</h3>
            <div class="paragraph">
              <p>
                Launchpad is incredibly powerful but the class loading model
                used is quite tricky. The
                <a
                  href="https://bnd.bndtools.org/chapters/315-launchpad-testing.html"
                  >manual of Launchpad</a
                >
                goes into some of these details. If you want to use Launchpad in
                anger, make sure you have read this section.
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="sect1">
        <h2 id="_external_dependencies">External Dependencies</h2>
        <div class="sectionbody">
          <div class="sect2">
            <h3 id="_tldr_8">TL;DR</h3>
            <div class="paragraph">
              <p>
                In this section, we create another <em>provider</em> for the
                Eval API using Javascript via the
                <a
                  href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino"
                  >Mozilla Rhino interpreter</a
                >. We will show how to add a dependency from Maven Central to
                your build and use it in a project.
              </p>
            </div>
            <div class="paragraph">
              <p>
                You can follow a short video about
                <a
                  href="https://bndtools.org/workspace.html#external-dependencies"
                  >External Dependencies</a
                >
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_rhino">Rhino</h3>
            <div class="paragraph">
              <p>
                Rhino is a Javascript interpreter that we can use to evaluate
                the expressions a bit more professional than the regular
                expression hack we used in the
                <code>com.example.eval.simple.provider</code>. Looking at the
                Rhino documentation, we can evaluate an expression with the
                following method:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">double</span> eval(<span class="predefined-type">String</span> expression) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">Context</span> cx = <span class="predefined-type">Context</span>.enter();
        <span class="keyword">try</span> {
            Scriptable scope = cx.initStandardObjects();
            <span class="predefined-type">Object</span> result = cx.evaluateString(scope, expression, <span class="string"><span class="delimiter">&quot;</span><span class="content">?</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>, <span class="predefined-constant">null</span>);
            <span class="keyword">if</span> (result <span class="keyword">instanceof</span> <span class="predefined-type">Number</span>)
                <span class="keyword">return</span> ((<span class="predefined-type">Number</span>) result).doubleValue();
            <span class="keyword">return</span> <span class="predefined-type">Double</span>.NaN;
        } <span class="keyword">finally</span> {
            <span class="predefined-type">Context</span>.exit();
        }
    }</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_create_a_rhino_provider_project">
              Create a Rhino Provider Project
            </h3>
            <div class="paragraph">
              <p>
                Create a project called
                <code>com.example.eval.rhino.provider</code>. It should be clear
                now why we chose the naming pattern. All projects related to the
                Eval API are now close together in the Bndtools/Package
                explorer.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Using the <code>Provider Bundle</code> template, you will be
                asked for the name for a component. Use
                <code>RhinoEvalImpl</code> for this name.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_create_a_component_2">Create a Component</h3>
            <div class="paragraph">
              <p>
                The template has already provided a component for you. The
                <code>RhinoEvalImpl</code> class should give the following
                source code:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="keyword">package</span> <span class="namespace">com.example.eval.provider</span>;
    <span class="keyword">import</span> <span class="include">org.osgi.service.component.annotations.Component</span>;
    <span class="annotation">@Component</span>
    <span class="directive">public</span> <span class="type">class</span> <span class="class">RhinoEvalImpl</span> {    }</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>You can modify it to:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="keyword">package</span> <span class="namespace">com.example.eval.rhino.provider</span>;

    <span class="keyword">import</span> <span class="include">org.mozilla.javascript.Context</span>;
    <span class="keyword">import</span> <span class="include">org.mozilla.javascript.Scriptable</span>;
    <span class="keyword">import</span> <span class="include">org.osgi.service.component.annotations.Component</span>;

    <span class="keyword">import</span> <span class="include">com.example.eval.api.Eval</span>;

    <span class="annotation">@Component</span>
    <span class="directive">public</span> <span class="type">class</span> <span class="class">RhinoEvalImpl</span> <span class="directive">implements</span> Eval {

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">double</span> eval(<span class="predefined-type">String</span> expression) <span class="directive">throws</span> <span class="exception">Exception</span> {
            <span class="predefined-type">Context</span> cx = <span class="predefined-type">Context</span>.enter();
            <span class="keyword">try</span> {
                Scriptable scope = cx.initStandardObjects();
                <span class="predefined-type">Object</span> result = cx.evaluateString(scope, expression, <span class="string"><span class="delimiter">&quot;</span><span class="content">?</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>, <span class="predefined-constant">null</span>);
                <span class="keyword">if</span> (result <span class="keyword">instanceof</span> <span class="predefined-type">Number</span>)
                    <span class="keyword">return</span> ((<span class="predefined-type">Number</span>) result).doubleValue();
                <span class="keyword">return</span> <span class="predefined-type">Double</span>.NaN;
            } <span class="keyword">finally</span> {
                <span class="predefined-type">Context</span>.exit();
            }
        }

    }</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_external_dependencies_2">External Dependencies</h3>
            <div class="paragraph">
              <p>
                This code will have errors. You should now be able to add the
                missing <code>Eval</code> interface by adding the
                <code>com.example.eval.api</code> project to your
                <code>-buildpath</code> in the <code>bnd.bnd</code> file via the
                <b class="button">Build</b> tab.
              </p>
            </div>
            <div class="paragraph">
              <p>
                The <code>com.example.eval.api</code> was in the
                <em>Workspace repository</em>, so we could find it, but the
                Rhino dependencies cannot be found in the repositories. This
                mechanism, therefore, does not work here.
              </p>
            </div>
            <div class="paragraph">
              <p>
                <span class="image"
                  ><img src="img/bndtools-rhino.png" alt="bndtools rhino"
                /></span>
              </p>
            </div>
            <div class="paragraph">
              <p>
                However, we can find this dependency on
                <a href="https://search.maven.org/search?q=rhino"
                  >Maven Central</a
                >:
              </p>
            </div>
            <div class="paragraph">
              <p>
                <span class="image"
                  ><img
                    src="img/bndtools-rhino-search.png"
                    alt="bndtools rhino search"
                /></span>
              </p>
            </div>
            <div class="paragraph">
              <p>
                Searching for external dependencies on Maven Central is not
                always easy. Sadly, many organizations prefer to wrap a bundle
                when it lacks a feature. This means that finding the right
                bundle is sometimes wading through a lot of dead bundles.
                However, in this case, it is clear that at the time of this
                writing the <code>org.mozilla:rhino:1.7.12</code> is
                <em>GAV</em> coordinates of the proper <em>artifact</em>.
              </p>
            </div>
            <div class="paragraph">
              <p>A GAV has the following syntax:</p>
            </div>
            <div class="literalblock">
              <div class="content">
                <pre>
GAV ::=  groupId ':' artifactId ( ':' extension ( ':' classifier )? )? ':' version</pre
                >
              </div>
            </div>
            <div class="paragraph">
              <p>
                The <code>groupId</code> is an organizational identifier. For
                example, all bnd code is in the
                <code>biz.aQute.bnd</code> group. The
                <code>artifactId</code> identifies the <em>program</em> name.
                The version should be clear. One note, in bnd, versions have a
                proper syntax, that is, <code>1.2.3</code> is exactly the same
                version as <code>01.02.03</code>. Maven uses the version string
                as an opaque identifier and sees <code>01.02.03</code> as
                distinctly different than <code>1.2.3</code>.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_maven_bnd_repository">Maven Bnd Repository</h3>
            <div class="paragraph">
              <p>
                The workspace template we used uses two repositories that are
                defined in the <code>cnf/ext/defaults.bnd</code> file. These
                repositories are linked to Maven Central. The Build repository
                contains artifacts that should never be used in runtime. The
                Runtime repository can be used to compile against or used in
                runtime.
              </p>
            </div>
            <div class="paragraph">
              <p>
                We can add the Rhino GAV, <code>org.mozilla:rhino:1.7.12</code>,
                to the Runtime repository. The GAVs for the Runtime repository
                are stored in the <code>cnf/ext/runtime.mvn</code> file. If you
                open this file, it should look similar to:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="mvn">    org.apache.felix:org.apache.felix.framework:6.0.3
    org.apache.felix:org.apache.felix.framework.security:2.6.1

    org.apache.felix:org.apache.felix.configadmin:1.9.16
    org.apache.felix:org.apache.felix.configurator:1.0.10
    org.apache.felix:org.apache.felix.coordinator:1.0.2
    org.apache.felix:org.apache.felix.eventadmin:1.5.0
    org.apache.felix:org.apache.felix.fileinstall:3.6.4
    org.apache.felix:org.apache.felix.http.servlet-api:1.1.2
    org.apache.felix:org.apache.felix.http.jetty:4.0.14</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                As you can see, these mvn files are a list of GAVs. You can add
                the <code>org.mozilla:rhino:1.7.12</code> GAV in this file and
                save it. This will automatically update the repositories.
                Therefore, you can now search in the repositories view.
              </p>
            </div>
            <div class="paragraph">
              <p>
                <span class="image"
                  ><img
                    src="img/bndtools-rhino-found.png"
                    alt="bndtools rhino found"
                /></span>
              </p>
            </div>
            <div class="paragraph">
              <p>
                We can now go to the <code>bnd.bnd</code> file and select the
                <b class="button">Build</b> and add the
                <code>org.mozilla.rhino</code> dependency on the
                <code>-buildpath</code>. This will add it to the
                <code>Bnd Bundle Path</code> in the Bndtools Explorer.
              </p>
            </div>
            <div class="paragraph">
              <p>
                In the <code>RhinoEvalImpl.java</code> source code we can now do
                the imports and make it compile correctly.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_gogo_command_2">Gogo Command</h3>
            <div class="paragraph">
              <p>
                To exercise this provider, we want to make it a Gogo command. We
                therefore need to add
                <code>org.apache.felix.gogo.runtime</code> to the
                <code>-buildpath</code> in the <code>bnd.bnd</code> file. The
                source of the <code>bnd.bnd</code> file should look like:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">    -buildpath: \
        osgi.annotation,\
        org.osgi.service.component.annotations,\
        com.example.eval.api;version=latest,\
        org.apache.felix.gogo.runtime

    -testpath: \
        osgi.enroute.junit.wrapper, \
        osgi.enroute.hamcrest.wrapper</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Then add the <code>@GogoCommand</code> annotation to the
                <code>EvalImpl</code> class.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="java">    <span class="annotation">@GogoCommand</span>(scope=<span class="string"><span class="delimiter">&quot;</span><span class="content">rhino</span><span class="delimiter">&quot;</span></span>, function={<span class="string"><span class="delimiter">&quot;</span><span class="content">eval</span><span class="delimiter">&quot;</span></span>})
    <span class="annotation">@Component</span>
    <span class="directive">public</span> <span class="type">class</span> <span class="class">RhinoEvalImpl</span> <span class="directive">implements</span> Eval {...}</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_running_in_the_playground_2">Running in the Playground</h3>
            <div class="paragraph">
              <p>
                Open the <code>bnd.bnd</code> file of the
                <code>com.example.playground</code> project that we created in
                the starting section. Then select the
                <b class="button">Run</b> tab. In this tab you can add the
                <code>com.example.eval.rhino.provider</code> bundle to the
                initial requirements.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Select <code>auto</code> in the popup menu on the left side of
                the <b class="button">Resolve</b> button. The resolve will then
                automatically happen on saving the file.
              </p>
            </div>
            <div class="paragraph">
              <p>
                <span class="image"
                  ><img
                    src="img/bndtools-rhino-auto.png"
                    alt="bndtools rhino auto"
                /></span>
              </p>
            </div>
            <div class="paragraph">
              <p>Save the file.</p>
            </div>
            <div class="paragraph">
              <p>
                If the framework was still running, the new bundles will
                automatically be added. We should then immediately be able to
                run the command:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    g! rhino:eval 1+2
    3.0</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_summary_6">Summary</h3>
            <div class="paragraph">
              <p>
                In this chapter we created a second provider to the Eval
                interface. For this provider, we had to find an external
                dependency on Maven Central. We found the Mozilla Rhino
                Javascript interpreter. This dependency was added to the
                <code>runtime.mvn</code> file. After saving this file, it became
                available to add it to the <code>-buildpath</code>.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Last, a <code>@GogoCommand</code> annotation was added to the
                component to be able to test it in Gogo.
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="sect1">
        <h2 id="_application">Application</h2>
        <div class="sectionbody">
          <div class="sect2">
            <h3 id="_tldr_9">TL;DR</h3>
            <div class="paragraph">
              <p>
                Bndtools supports <em>executable jars</em>. These are JARs that
                contain <strong>all</strong> dependencies and can directly be
                executed by the Java VM. This section outlines the role of the
                application project and shows how you can create such an
                executable JAR.
              </p>
            </div>
            <div class="paragraph">
              <p>
                You may also want to take a look at
                <a href="https://bndtools.org/workspace.html#executable-jars"
                  >Executable JARs</a
                >.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_application_bundle">Application Bundle</h3>
            <div class="paragraph">
              <p>
                In OSGi, an <em>application</em> is a bundle that acts as the
                <em>root</em> of a <em>runtime assembly</em>. The application is
                a bundle that is specific for some complete end-user
                functionality. A very important aspect of an application is that
                it is a <em>leaf</em> node in a dependency graph, it
                <strong>must</strong> never required by any other bundle. In a
                perfect system, this is the only part that is not reusable.
              </p>
            </div>
            <div class="paragraph">
              <p>
                For non-application bundles, it is recommended to minimize
                dependencies because every dependency makes it harder to use
                that bundle in different applications. However, the application
                bundle is free from these constraints. An application can be a
                web application but also for a specific device configuration. It
                is the thing that you deploy for your customers.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Applications should only <em>require</em> other code and rarely
                include any code since that code can never be reused. We,
                therefore, create a new project that is dedicated to only being
                an application, it does not contain code.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_define_an_application_project">
              Define an Application Project
            </h3>
            <div class="paragraph">
              <p>
                Create a new project from the
                <code><a href="#empty">[empty]</a></code> template:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">    com.example.application</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                In this project, create a file called
                <code>application.bndrun</code>. Open it, and go to the
                <b class="button">Run</b> tab.
              </p>
            </div>
            <div class="paragraph">
              <p>
                We now have to establish what needs to be a part of the
                application. For this example, we drag the following bundles to
                the <code>Initial Requirements</code> list.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">    org.apache.felix.gogo.command
    org.apache.felix.gogo.shell
    com.example.eval.simple.provider</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Select a <code>Resolve mode</code> of <code>auto</code> and then
                click the <b class="button">Debug OSGi</b> to see if the
                application works.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    ____________________________
    Welcome to Apache Felix Gogo
    g! eval 3+5
    8.0
    g!</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_executable_jar">Executable JAR</h3>
            <div class="paragraph">
              <p>
                To deploy the application we need a file in a deployable
                <em>format</em>. One of the formats supported by
                <code>bndrun</code> files is the <em>executable JAR</em>. This
                format packs a framework and all necessary bundles in a single
                JAR file. You can export this by adding the following in the
                <code>bnd.bnd</code> file in the
                <code>com.example.application</code> project.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">    -dependson      *
    -fixupmessages  The JAR is empty
    -export         application.bndrun</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                This will tell bnd to create an executable JAR whenever
                something changes. (The <code>-dependson *</code> makes sure
                that this is the last project built so that the dependencies are
                ready when we export them to the executable JAR.)
              </p>
            </div>
            <div class="paragraph">
              <p>
                If you open the <code>target</code> directory in a shell, you
                now see a file <code>application.bndrun.jar</code>. This file
                can directly be run from the command line.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    $ cd com.example/com.application.playground
    $ java -jar target/application.bndrun.jar
    g! simple:eval 3+7
    10
    g!</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_docker_image">Docker Image</h3>
            <div class="paragraph">
              <p>Executable JARs are perfect for a Docker image.</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="Dockerfile">    FROM java:8-jdk-alpine
    ADD target/application.bndrun.jar /
    WORKDIR /data
    ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;/application.bndrun.jar&quot;]</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>You can now build the docker image and run it.</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    $ docker build .
    Sending build context to Docker daemon  6.456MB
    Step 1/4 : FROM                            ggtools/java8
    ---&gt; f8f0aa8056f4
    Step 2/4 : MAINTAINER                      pkriens@gmail.com
    ---&gt; Using cache
    ---&gt; 0e918347c1f3
    Step 3/4 : CMD                             java -jar application.bndrun.jar
    ---&gt; Using cache
    ---&gt; 9f16d98f80ca
    Step 4/4 : ADD                             target/application.bndrun.jar application.bndrun.jar
    ---&gt; b1559881a6eb
    Successfully built b1559881a6eb
    $ docker run -i    b1559881a6eb
    ____________________________
    Welcome to Apache Felix Gogo
    g! rhino:eval 41+1
    42.0
    g!</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_summary_7">Summary</h3>
            <div class="paragraph">
              <p>
                In this chapter we learned about the concept of
                <em>executable JARs</em>: JARs that contain the OSGi framework
                and all necessary bundles. We then looked at how to build such a
                JAR and used it to create a Docker image.
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="sect1">
        <h2 id="_gradle">Gradle</h2>
        <div class="sectionbody">
          <div class="sect2">
            <h3 id="_tldr_10">TL;DR</h3>
            <div class="paragraph">
              <p>
                If you are a user of a bnd workspace and there is
                <em>build master</em> that maintains the low level details then
                you can skip this section. This is only for build masters.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Bndtools uses Gradle as the
                <em>continuous integration</em> build tool. Every bnd workspace
                can automatically be built by Gradle using straight generic
                templates. The output of this build is identical to the
                artifacts built in Eclipse or Intellij.
              </p>
            </div>
            <div class="paragraph">
              <p>
                The templates use <code>gradlew</code>, which is a small script
                that fetches the correct version of Gradle. You can start a
                build typing <code>./gradlew clean build</code>, getting a list
                of the tasks is <code>./gradlew tasks</code>.
              </p>
            </div>
            <div class="paragraph">
              <p>
                You may also want to look at
                <a href="https://bndtools.org/workspace.html#gradle-integration"
                  >Gradle Integration</a
                >
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_gradle_setup">Gradle Setup</h3>
            <div class="paragraph">
              <p>
                The workspace template that was used in an earlier session
                provided a bnd workspace to Bndtools. However, it also included
                setup for <em>Gradle</em>. Gradle is one of the primary build
                tools, nowadays competing with <em>maven</em> for primacy. The
                main difference is that Maven is very declarative while Gradle
                allows fine-grained control using the Groovy or Kotlin language.
              </p>
            </div>
            <div class="paragraph">
              <p>
                This makes it possible to build all the bundles in the
                workspace, and the application, via the command-line. The
                primary purpose of this is to build the artifacts on a different
                system than the developer&#8217;s. Before continuous integration
                on external servers was the norm, many projects found that the
                application worked on one developer&#8217;s machine but not
                necessarily on another due to a difference in configuration.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_building_2">Building</h3>
            <div class="paragraph">
              <p>
                The workspace is set up to build all projects in the workspace
                directory using the Gradle bnd plugin. This plugin takes the bnd
                files and tells Gradle how to compile and build the artifacts.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Therefore, to build the workspace, you can do the following:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    $ cd  com.example
    $ ./gradlew clean build
    .....
    BUILD SUCCESSFUL in 4s
    13 actionable tasks: 13 executed</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                The bnd Gradle plugin will build exactly the same artifacts as
                the Eclipse IDE.
              </p>
            </div>
            <div class="paragraph">
              <p>Lets try out how the application runs.</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    $ java -jar com.example.application/target/application.bndrun.jar
    ____________________________
    Welcome to Apache Felix Gogo
    g! eval 41+1
    42.0</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_gradle_tidbits">Gradle Tidbits</h3>
            <div class="ulist">
              <ul>
                <li>
                  <p>
                    There is no need to install Gradle. The workspace template
                    contains two script (<code>gradlew</code> for MacOS &amp;
                    Linux, and <code>gradlew.bat</code> for Windows) that will
                    download an appropriate Gradle executable.
                  </p>
                </li>
                <li>
                  <p>
                    You can find out the tasks you can run with
                    <code>./gradlew tasks</code>
                  </p>
                </li>
                <li>
                  <p>
                    By default, Gradle compiles in the same directory as
                    Eclipse/Intellij. This means that they can sometimes
                    override each other&#8217;s files. This is only a problem if
                    you build locally with Gradle, which is generally not
                    necessary. If Eclipse is confused, it is likely a Gradle
                    build that destroyed its files.
                  </p>
                </li>
              </ul>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_using_gradle">Using Gradle</h3>
            <div class="paragraph">
              <p>
                The default workspace build with Gradle is driven by the bnd
                configuration files. Since bnd also runs inside Eclipse and
                Intellij, there is no need for special Gradle configuration.
                However, there are situations where you need to generate sources
                or run some special Gradle plugin. For this reason, each project
                directory can have a <code>build.gradle</code> file that extends
                the Gradle setup. This can be a lifesaver. However, these gradle
                files are <em>not</em> run inside the IDE. It is therefore
                recommended to limit the use of this facility to cases when
                there is no bnd solution.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_when_to_use">When to Use</h3>
            <div class="paragraph">
              <p>
                The primary purpose of Gradle is to do the CI build on a remote
                server. However, I&#8217;ve noticed that a lot of developers do
                local builds with Gradle, often from the distrust that the CI
                build might not be the same. The bnd team sees any discrepancy
                between the Eclipse IDE and the Gradle build as a high priority
                error and thus they are rare. Trust Eclipse &#8230;&#8203;
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="sect1">
        <h2 id="_git">Git</h2>
        <div class="sectionbody">
          <div class="sect2">
            <h3 id="_tldr_11">TL;DR</h3>
            <div class="paragraph">
              <p>
                If you have a <em>build master</em> that sets up the workspace
                for you then this section unnecessary for you. The following
                sections are only intended for people that need to maintain
                workspaces.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Currently the workspace is local on our laptop. Today, by far
                the most widespread solution for a Source Control Management
                System (SCMS) is Git. In this section we&#8217;ll connect the
                <code>com.example</code> workspace to Github and use the Github
                continuous integration servers (Github Actions) to build it.
              </p>
            </div>
            <div class="paragraph">
              <p>
                You may also want to look at
                <a
                  href="https://bndtools.org/workspace.html#github&#8212;&#8203;actions"
                  >Github &amp; Actions</a
                >.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_fixups">Fixups</h3>
            <div class="paragraph">
              <p>
                Git does not store empty folders. This is a nuisance for Eclipse
                since Eclipse will not build a project if a source folder is
                missing because it was empty. Since on your local system the
                folder is already created, there is no warning or error.
                However, when someone else pulls your repository, it will be
                missing and the workspace won&#8217;t build. So you should check
                that all source folders are not empty. An easy fix is to add an
                empty <code>.gitignore</code> file. For example:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    $ touch src/test/java/.gitignore</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_init">Init</h3>
            <div class="paragraph">
              <p>The following command initializes git for the repository.</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    $ git init; \
      git add .; \
      git commit -m &quot;first commit&quot;</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>The workspace directory is now a git workspace.</p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_store_on_github">Store on Github</h3>
            <div class="paragraph">
              <p>
                To safeguard our work, we want to store it in a remote
                repository. Github is free. If you do not have an account
                already,
                <a href="https://github.com/join?source=header-home"
                  >create one</a
                >. Then create a
                <a
                  href="https://help.github.com/en/github/creating-cloning-and-archiving-repositories/creating-a-new-repository"
                  >new repository</a
                >
                with the name <code>com.example</code>. You should not
                initialize the repository with a <code>`.gitignore</code> file.
                The <code>readme</code> file is optional.
              </p>
            </div>
            <div class="paragraph">
              <p>
                After you&#8217;ve created the repository, you get a window that
                looks more or less like:
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img
                  src="img/github-after-create.png"
                  alt="github after create"
                />
              </div>
            </div>
            <div class="paragraph">
              <p>
                We have an existing repository so you should copy the lines
                after
                <strong
                  >…or push an existing repository from the command line</strong
                >.
              </p>
            </div>
            <div class="paragraph">
              <p>
                This should be similar to the following but instead of
                <code>pkriens</code> you should use your Github user name.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">    $ git remote add origin git@github.com:pkriens/com.example.git; \
      git push -u origin master
    54 files changed, 2150 insertions(+)
    create mode 100644 .gitattributes
    create mode 100644 .github/workflows/cibuild.yml
    create mode 100644 .gitignore
    create mode 100644 .gradle-wrapper/gradle-wrapper.jar
    create mode 100644 .gradle-wrapper/gradle-wrapper.properties
    create mode 100644 .travis.yml
    create mode 100644 LICENSE
    create mode 100644 cnf/.classpath
    ........
    create mode 100755 gradlew
    create mode 100644 gradlew.bat
    create mode 100644 settings.gradle
    $</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                If you can now go to the Github repository at
                <a href="https://github.com/pkriens/com.example" class="bare"
                  >https://github.com/pkriens/com.example</a
                >
                (don&#8217;t) forget to change to your user name).
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="img/github-repository.png" alt="github repository" />
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_github_workflow_actions">Github Workflow Actions</h3>
            <div class="paragraph">
              <p>
                Reliable software must always be built on a server. Github has
                support for Continuous Integration (CI) with their
                <code>Actions</code> feature. By adding a
                <em>workflow</em> configuration to your workspace, your code can
                automatically be built. Our template already contained such a
                workflow.
              </p>
            </div>
            <div class="paragraph">
              <p>
                The <code>.github/workflow</code> directory contains a file
                called <code>build.yml</code>:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="actions">    name: Build

    on:
        push:
        pull_request:

    env:
        LC_ALL:       en_US.UTF-8
        GRADLE_OPTS: -Dorg.gradle.parallel=false

    jobs:
        build:
            name:     build on OpenJDK Linux
            runs-on:  ubuntu-latest
            steps:
            -   name: Git Checkout
                uses: actions/checkout@v1
            -   name: Set up Java
                uses: actions/setup-java@v1
                with:
                    java-version: 1.8
            -   name: Build
                shell: bash
                run: ./gradlew build</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                This file instructs Github to react to a <code>push</code> or
                <code>pull_request</code> event in the repository. It will
                execute all jobs that are defined in this workflow file. The
                Yaml file also defines a number of environment properties.
              </p>
            </div>
            <div class="paragraph">
              <p>
                In this case, there is a single job that compiles with the
                OpenJDK Java on Linux. Github also supports MacOS and Windows.
                The steps in the workflow are checkout, setup Java, and the
                build is running gradle in a bash shell. It is surprisingly
                simple.
              </p>
            </div>
            <div class="paragraph">
              <p>
                If you click on the <b class="button">Actions</b> above your
                repository window, you should see that the repository has been
                built.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="img/github-actions.png" alt="github actions" />
              </div>
            </div>
            <div class="paragraph">
              <p>
                If you click on the <b class="button">CI Build</b> link, you can
                get access to the build log.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="img/github-buildlog.png" alt="github buildlog" />
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="sect1">
        <h2 id="_release_to_remote_repository">Release to Remote Repository</h2>
        <div class="sectionbody">
          <div class="sect2">
            <h3 id="_tldr_12">TL;DR</h3>
            <div class="paragraph">
              <p>
                If you are a user of a bnd workspace and there is
                <em>build master</em> that maintains the low level details then
                you can skip this section. This is only for build masters.
              </p>
            </div>
            <div class="paragraph">
              <p>
                To be able to share bundles, it is necessary to
                <em>release</em> a workspace to a remote repository. This
                chapter shows how the bundles in a workspace can be released to
                Sonatype&#8217;s Open Source repository. You will be shown how
                to do snapshot releases and releasing a final release to Maven
                Central using <em>staging</em>.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_maven_repositories">Maven Repositories</h3>
            <div class="paragraph">
              <p>
                Maven repositories have become the de-facto standard in our
                industry. Maven Central is the largest open source repository
                for Java. Therefore, bnd has extensive support for releasing to
                Maven Nexus and Artifactory repositories.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Maven has the concept of <em>snapshots</em>. These are revisions
                that are not released yet. Whether an artifact in a build is a
                snapshot or a release is defined by the version. If the version
                ends with <code>SNAPSHOT</code>, bnd will assume it must be
                released as a snapshot version, otherwise it will released it as
                a final release.
              </p>
            </div>
            <div class="paragraph">
              <p>
                The normal process is then to release a snapshot version.
                Therefore, in <code>cnf/build.bnd</code>, change the
                <code>Bundle-Version</code> into a snapshot version.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">        Bundle-Version                                1.0.0.SNAPSHOT</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                We also want to make sure the version for Maven is consistently
                formatted. In OSGi, versions can be written differently but are
                treated as the same version whereas in Maven a version is an
                opaque identifier.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">        -pom:                   version=${versionmask;===s;${@version}}</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                The <code>${@version}</code> is set by the pom generator when
                this macro is expanded. It is the version calculated for the
                bundle itself. This allows us to slightly tweak the version. We
                are using the major, minor, and micro part but then only add the
                snapshot part if present. We ignore the qualifier. This is a
                timestamp and does not work well with Maven.
              </p>
            </div>
            <div class="paragraph">
              <p>
                A release to Maven Central will require <em>staging</em>. With
                staging, a temporary repository is created with all the
                artifacts. The files are then signed in that repository. Before
                you can release to Maven Central, a verification process will
                validate each artifact. If the verification process accepts the
                temporary repository, it can be promoted to Maven Central.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Releasing should not be done from a local developer&#8217;s
                machine so as to avoid depending on a local set up. The best
                place to release is from a remote service. In this example, we
                will use Github Actions to release to the
                <a href="https://oss.sonatype.org" class="bare"
                  >https://oss.sonatype.org</a
                >
                server.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_release_repository">Release Repository</h3>
            <div class="paragraph">
              <p>
                To release, we need a release repository. This is a Maven Bnd
                Repository that is listed in the
                <code>-releaserepo</code> instructions. Enter the following
                information in the <code>cnf/build.bnd</code> file.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">  -plugin.8.nexus: \
    aQute.bnd.repository.maven.provider.MavenBndRepository; \
        snapshotUrl = 'https://oss.sonatype.org/content/repositories/snapshots/'; \
        releaseUrl  = 'https://oss.sonatype.org/service/local/staging/deploy/maven2/'; \
                noupdateOnRelease=true; \
        name=&quot;Sonatype&quot;

  -releaserepo                Sonatype</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_authentication">Authentication</h3>
            <div class="paragraph">
              <p>
                Sonatype recommends rather strongly to create an authentication
                token. To create such a token, you need to login to
                <a href="https://oss.sonatype.org">Sonatype Nexus</a>. This
                requires an account that you can register on their
                <a href="https://central.sonatype.org/pages/ossrh-guide.html"
                  >website</a
                >.
              </p>
            </div>
            <div class="sect3">
              <h4 id="_group_id">Group Id</h4>
              <div class="paragraph">
                <p>
                  To get a username and a password, you need to claim a
                  <em>groupid</em>. The group id is a unique name for your part
                  of the repository. In this example, we&#8217;ll use
                  <code>biz.aQute.example</code> since I own the
                  <code>biz.aQute</code> group prefix. However, you will need
                  your own group id.
                </p>
              </div>
              <div class="paragraph">
                <p>
                  We need to register the group id with bnd in the
                  <code>cnf/build.bnd</code> file.
                </p>
              </div>
              <div class="listingblock">
                <div class="content">
                  <pre
                    class="CodeRay highlight"
                  ><code data-lang="bnd">        -groupid                                        biz.aQute.example</code></pre>
                </div>
              </div>
            </div>
            <div class="sect3">
              <h4 id="_username_password">Username &amp; Password</h4>
              <div class="paragraph">
                <p>
                  Once you are logged in, click on your user name in the right
                  top, and select <b class="button">Profile</b>. Then select the
                  pop menu in the left <b class="button">User Token</b>. There
                  you can create a user token. This consists of two parts, a
                  user name and a password. In the rest of the text, these parts
                  are called <code>SONATYPE_USERNAME</code> and
                  <code>SONATYPE_PASSWORD</code>.
                </p>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_connection_settings">Connection Settings</h3>
            <div class="paragraph">
              <p>
                Since we will be releasing from a continuous integration server,
                we cannot use the local authentication provided by the bnd
                <a
                  href="https://bnd.bndtools.org/instructions/connection-settings.html"
                  >connection settings</a
                >. These settings only works locally on your own computer.
                However, we can also define the connection settings also in the
                bnd file. Since passwords cannot be stored in the source code
                for obvious reason, we are going to assume that these secrets
                are available as <em>environment variables</em>. Environment
                variables allow us to test the release process locally but they
                can also be used by Github Actions, Travis, and other continuous
                integration services.
              </p>
            </div>
            <div class="paragraph">
              <p>
                To pass the environment variables to bnd, we need the
                <code>-connection-settings</code> instruction in
                <code>cnf/build.bnd</code>.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">        -connection-settings: \
                server; \
                        id=https://oss.sonatype.org; \
                        username=${env;SONATYPE_USERNAME;}; \
                        password=${env;SONATYPE_PASSWORD;}, \
                bnd</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_local_test_snapshots">Local Test Snapshots</h3>
            <div class="paragraph">
              <p>
                Everything is now set up to release a snapshot to the Sonatype
                snapshot repository. To test this, we can go to the shell and
                use <code>gradlew</code> to release.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">        $ cd com.example
        $ export SONATYPE_USERNAME=...
        $ export SONATYPE_PASSWORD=...
        $ ./gradlew clear release</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                This will release the whole workspace to the snapshot
                repository.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Looking at the output, we see that the
                <code>com.example.playground</code> project was also built. We
                can disable releasing this project by overriding the
                <code>-releaserepo</code> in the <code>bnd.bnd</code> file of
                the <code>com.example.playground</code> project.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="bnd">        -releaserepo:</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_github_actions">Github Actions</h3>
            <div class="paragraph">
              <p>
                Github automatically builds both PRs and all commits to the
                master branch. For PR&#8217;s we want to trigger a build so we
                can run the tests and validate the PR. However, if we commit to
                <code>master</code>, we want to run the release process. The
                template gave us the following workflow document in
                <code>.github/workflows/build.yml</code> in the root of our
                workspace:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="yaml"><span class="error">        </span><span class="key">name</span>: <span class="string"><span class="content">CI Build</span></span>

<span class="error">        </span><span class="key">on</span>:
<span class="error">        </span><span class="error">        </span><span class="key">push</span>:
<span class="error">        </span><span class="error">        </span><span class="key">pull_request</span>:

<span class="error">        </span><span class="key">env</span>:
<span class="error">        </span><span class="error">        </span><span class="key">LC_ALL</span>:       <span class="string"><span class="content">en_US.UTF-8</span></span>
<span class="error">        </span><span class="error">        </span><span class="key">GRADLE_OPTS</span>: <span class="string"><span class="content">-Dorg.gradle.parallel=false</span></span>

<span class="error">        </span><span class="key">jobs</span>:
<span class="error">        </span><span class="error">        </span><span class="key">build</span>:
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">name</span>:     <span class="string"><span class="content">build on OpenJDK Linux</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">runs-on</span>:  <span class="string"><span class="content">ubuntu-latest</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">steps</span>:
<span class="error">        </span><span class="error">        </span><span class="error">        </span>-   <span class="string"><span class="content">name: Git Checkout</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">uses</span>: <span class="string"><span class="content">actions/checkout@v1</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span>-   <span class="string"><span class="content">name: Set up Java</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">uses</span>: <span class="string"><span class="content">actions/setup-java@v1</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">with</span>:
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">java-version</span>: <span class="string"><span class="content">1.8</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span>-   <span class="string"><span class="content">name: Build</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">shell</span>: <span class="string"><span class="content">bash</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">run</span>: <span class="string"><span class="content">./gradlew build</span></span></code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                We can modify this to only run on a non-master commit. We can
                then add a second workflow file for commits on the master
                branch.
              </p>
            </div>
            <div class="paragraph">
              <p>
                For the original file, we only need to change the event section
                that is listed under the <code>on:</code> attribute:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="yaml"><span class="error">        </span><span class="key">on</span>:
<span class="error">        </span><span class="error">        </span><span class="key">push</span>:
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">branches-ignore</span>: <span class="string"><span class="content">['master']</span></span>
<span class="error">        </span><span class="error">        </span><span class="key">pull_request</span>:</code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_github_secrets">Github Secrets</h3>
            <div class="paragraph">
              <p>
                We now need to register our SONATYPE_USERNAME and
                SONATYPE_PASSWORD with Github. You can add these secrets via the
                <code>Settings</code> of the repository. If you select the
                repository <code>Settings</code> page and then select the
                <code>Secrets</code> entry.
              </p>
            </div>
            <div class="paragraph">
              <p>
                In the <code>Secrets</code> section you can add the
                SONATYPE_USERNAME and SONATYPE_PASSWORD secrets.
              </p>
            </div>
            <div class="paragraph">
              <p>
                <span class="image"
                  ><img
                    src="img/github-actions-secrets.png"
                    alt="github actions secrets"
                /></span>
              </p>
            </div>
            <div class="paragraph">
              <p>
                We will now have to add the environment variables to the
                <code>.github/workflows/build.yml</code> file.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="yaml"><span class="error">        </span><span class="key">env</span>:
<span class="error">        </span><span class="error">        </span><span class="key">LC_ALL</span>:       <span class="string"><span class="content">en_US.UTF-8</span></span>
<span class="error">        </span><span class="error">        </span><span class="key">GRADLE_OPTS</span>: <span class="string"><span class="content">-Dorg.gradle.parallel=false</span><span class="content">
        SONATYPE_USERNAME: {{ secrets.SONATYPE_USERNAME }}</span></span>
<span class="error">        </span><span class="error">        </span><span class="key">SONATYPE_PASSWORD</span>: <span class="string"><span class="content">{{ secrets.SONATYPE_PASSWORD }}</span></span></code></pre>
              </div>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_release_workflow">Release Workflow</h3>
            <div class="paragraph">
              <p>
                From now on, this will not run when we commit on the master
                branch. For this, we add a second workflow file that is called
                <code>.github/workflows/release.yml</code>. This is a copy of
                the <code>.github/workflows/build.yml</code> with only the
                <code>on</code>, <code>env</code>, and <code>run</code> section
                slightly changed.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="yaml"><span class="error">        </span><span class="key">name</span>: <span class="string"><span class="content">CI Release</span></span>

<span class="error">        </span><span class="key">on</span>:
<span class="error">        </span><span class="error">        </span><span class="key">push</span>:
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">branches</span>: <span class="string"><span class="content">[ 'master']</span></span>

<span class="error">        </span><span class="key">env</span>:
<span class="error">        </span><span class="error">        </span><span class="key">LC_ALL</span>:       <span class="string"><span class="content">en_US.UTF-8</span></span>
<span class="error">        </span><span class="error">        </span><span class="key">GRADLE_OPTS</span>: <span class="string"><span class="content">-Dorg.gradle.parallel=false</span><span class="content">
        SONATYPE_USERNAME: {{ secrets.SONATYPE_USERNAME }}</span></span>
<span class="error">        </span><span class="error">        </span><span class="key">SONATYPE_PASSWORD</span>: <span class="string"><span class="content">{{ secrets.SONATYPE_PASSWORD }}</span></span>

<span class="error">        </span><span class="key">jobs</span>:
<span class="error">        </span><span class="error">        </span><span class="key">build</span>:
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">name</span>:     <span class="string"><span class="content">build on OpenJDK Linux</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">runs-on</span>:  <span class="string"><span class="content">ubuntu-latest</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">steps</span>:
<span class="error">        </span><span class="error">        </span><span class="error">        </span>-   <span class="string"><span class="content">name: Git Checkout</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">uses</span>: <span class="string"><span class="content">actions/checkout@v1</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span>-   <span class="string"><span class="content">name: Set up Java</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">uses</span>: <span class="string"><span class="content">actions/setup-java@v1</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">with</span>:
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">java-version</span>: <span class="string"><span class="content">1.8</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span>-   <span class="string"><span class="content">name: Build</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">shell</span>: <span class="string"><span class="content">bash</span></span>
<span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="error">        </span><span class="key">run</span>: <span class="string"><span class="content">./gradlew release</span></span></code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                We can now commit the workspace to Git and check the Actions.
                Since this is a commit on the master branch, the release
                workflow will automatically be triggered.
              </p>
            </div>
            <div class="paragraph">
              <p>Some common pitfalls:</p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>Tabs instead of spaces, YAML files want spaces</p>
                </li>
                <li>
                  <p>Entering the secrets in the wrong repository</p>
                </li>
              </ul>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_pom_generation">POM Generation</h3>
            <div class="paragraph">
              <p>
                The POM is generated by bnd. It uses as much information as
                possible from the OSGi manifest headers, including the
                <code>groupId</code> instruction we set earlier.
              </p>
            </div>
            <div class="paragraph">
              <p>
                The POM generator uses the following Manifest headers to create
                the POM.
              </p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>Bundle-SymbolicName – The <code>artifactId</code>.</p>
                </li>
                <li>
                  <p>Bundle-Name – The <code>name</code>.</p>
                </li>
                <li>
                  <p>Bundle-Description – Goes into the POM description.</p>
                </li>
                <li>
                  <p>Bundle-DocURL – The <code>url</code> element.</p>
                </li>
                <li>
                  <p>
                    Bundle-Vendor – Organization name and url. The url part is
                    set if the header ends in an http or https url.
                  </p>
                </li>
                <li>
                  <p>Bundle-License – Added as license.</p>
                </li>
                <li>
                  <p>
                    Bundle-SCM – Source Control Management. All attributes are
                    expanded as elements.
                  </p>
                </li>
                <li>
                  <p>Bundle-Developers – Defines the developers.</p>
                </li>
              </ul>
            </div>
            <div class="paragraph">
              <p>An example of headers that work:</p>
            </div>
            <div class="literalblock">
              <div class="content">
                <pre>
Bundle-Vendor:    		OSGi Alliance http://www.osgi.org/
Bundle-Copyright: 		${copyright}
Bundle-License: 		http://opensource.org/licenses/apache2.0.php; \
                			link="http://www.apache.org/licenses/LICENSE-2.0"; \
                			description="Apache License, Version 2.0"
Bundle-DocURL:    		https://v2archive.enroute.osgi.org
Bundle-SCM:       		url=https://github.com/osgi/osgi.enroute, \
                  			connection=scm:git:https://github.com/osgi/osgi.enroute.git, \
                  			developerConnection=scm:git:git@github.com:osgi/osgi.enroute.git
Bundle-Developers: 		osgi; \
							email=info@osgi.org; \
							name="OSGi Alliance"; \
							organization="OSGi Alliance"</pre
                >
              </div>
            </div>
            <div class="paragraph">
              <p>
                The Bundle-SCM and Bundle-Developers headers are not OSGi
                standardized but they are necessary to release to Maven Central.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Releasing a non-snapshot release will automatically create the
                javadoc and sources jars.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_releasing">Releasing</h3>
            <div class="paragraph">
              <p>
                To release the workspace, we need to perform a number of steps.
              </p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>
                    Remove the <code>-SNAPSHOT</code> from the Bundle-Version in
                    <code>cnf/build.bnd</code>
                  </p>
                </li>
                <li>
                  <p>Commit the change in <code>cnf/build.bnd</code></p>
                </li>
                <li>
                  <p>Tag the commit with the version</p>
                </li>
                <li>
                  <p>Push the commit and tag to the master branch</p>
                  <div class="ulist">
                    <ul>
                      <li>
                        <p>Automatically build on Github Actions</p>
                      </li>
                    </ul>
                  </div>
                </li>
                <li>
                  <p>
                    Add the <code>-SNAPSHOT</code> again to the Bundle-Version
                    in <code>cnf/build.bnd</code>
                  </p>
                </li>
                <li>
                  <p>Commit the changes</p>
                  <div class="ulist">
                    <ul>
                      <li>
                        <p>Automatically build on Github Actions</p>
                      </li>
                    </ul>
                  </div>
                </li>
              </ul>
            </div>
            <div class="paragraph">
              <p>
                The first build will be a release build because the
                Bundle-Version does not contain <code>SNAPSHOT</code>. This will
                release to a <em>staging</em> repository. A staging repository
                is automatically created on a Nexus server. The name is
                therefore unknown. You will have to login to the Sonatype Nexus
                server and check the <b class="button">Staging Repositories</b>.
                Normally, you should see a repository that contains your group
                id name and a number. There might be many other staging
                repositories in this list.
              </p>
            </div>
            <div class="paragraph">
              <p>
                <span class="image"
                  ><img
                    src="img/nexus-staging-repos.png"
                    alt="nexus staging repos"
                /></span>
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_signing">Signing</h3>
            <div class="paragraph">
              <p>
                To release to Maven Central it is necessary to sign the files in
                the staging repository. The easiest way to do this is with the
                <a
                  href="https://github.com/bndtools/bnd/wiki/Install-bnd-on-the-command-line"
                  >bnd <em>command line</em> tool</a
                >. The <code>bnd nexus</code> command can retrieve the files
                from the repositories, calculate the signature, and then upload
                the signatures.
              </p>
            </div>
            <div class="paragraph">
              <p>
                The command uses the URL to the staging repository. This is
                generally a name with your mangled group id prefix and a number
                to make it unique. You can find this name on the Sonatype OSS
                Nexus under the
                <a href="https://oss.sonatype.org/#stagingRepositories"
                  >Staging Repositories</a
                >
                as discussed earlier. For example, <code>bizaqute-1387</code>.
                This is url is for the <code>-u</code> option.
              </p>
            </div>
            <div class="paragraph">
              <p>
                You will need a
                <a
                  href="https://blog.sonatype.com/2010/01/how-to-generate-pgp-signatures-with-maven/"
                  >GPG and a key</a
                >
                for signing the artifacts.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre
                  class="CodeRay highlight"
                ><code data-lang="shell">        $ bnd nexus -u https://oss.sonatype.org/service/local/repositories/bizaqute-1387 sign
        Passsword for pgp: ************</code></pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                The sign command will download all files and sign them locally.
                It then uploads the <code>asc</code> file to nexus. This keeps
                your GPG key local.
              </p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_closing_the_staging_repository">
              Closing the Staging Repository
            </h3>
            <div class="paragraph">
              <p>
                On the Sonatype Nexus you can now close the repository. This
                will trigger a validation. If this succeeds you can release the
                staging repository. This will copy your files to Maven Central.
              </p>
            </div>
            <div class="paragraph">
              <p>The validation process can be picky.</p>
            </div>
          </div>
          <div class="sect2">
            <h3 id="_summary_8">Summary</h3>
            <div class="paragraph">
              <p>
                In this chapter we created a Github Actions set up that released
                snapshots to the Sonatype OSS repository for every commit on the
                master branch. We then showed how to create a release version in
                a Sonatype staging repository.
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="sect1">
        <h2 id="_the_end">The End</h2>
        <div class="sectionbody">
          <div class="paragraph">
            <p>
              You&#8217;ve reached the end of this tour. If you&#8217;ve tried
              out all the examples then you should be able to get started with
              your own workspace and take advantage of OSGi.
            </p>
          </div>
          <div class="paragraph">
            <p>
              If you&#8217;ve a relatively small workspace with straightforward
              repositories then this book should probably suffice. The
              <a href="https://bnd.bndtools.org">bnd manual</a> has always been
              bnd&#8217;s weak point but it is definitely improving. There are
              an extensive
              <a
                href="https://bnd.bndtools.org/chapters/825-instructions-ref.html"
                >instruction index</a
              >
              and
              <a href="https://bnd.bndtools.org/chapters/855-macros-ref.html"
                >macro index</a
              >
              that are actually becoming quite useful.
            </p>
          </div>
          <div class="paragraph">
            <p>
              A tremendously valuable resource is the
              <a href="https://github.com/bndtools/bnd">bnd workspace itself</a
              >. This is a complex workspace that uses a large number of state
              of the art bnd features itself. The
              <a href="https://bndtools.org/community.html"
                >Bndtools mailing list</a
              >
              can be used to ask questions. Some simpler workspaces are for
              example
              <a href="https://github.com/aQute-os/biz.aQute.osgi.util"
                >aQute util</a
              >
              and
              <a
                href="https://wiki.eclipse.org/Bndtools_Support_for_Remote_Services_Development"
                >Bndtools Support for Remote Services Development</a
              >. If you&#8217;re an OSGi member, look at the OSGi build, it is
              also based on Bndtools.
            </p>
          </div>
          <div class="paragraph">
            <p>
              If you&#8217;re evaluating Bndtools to be used as replacement for
              a non-trivial system then you might want to
              <a href="mailto:Peter.Kriens@aQute.biz">contact me</a>. Converting
              a large build always contains many pitfalls and we might be able
              to save you a lot of work. Especially when you&#8217;re using PDE
              and want to enjoy OSGi, we could help a lot since we developed
              some software to automate the conversion.
            </p>
          </div>
          <div class="paragraph">
            <p>
              Last but not least, I am working on a book that dives much deeper
              into the OSGi aspects. Unfortunately, most of the OSGi books in
              the market are old and do not leverage Declarative Services. If
              you follow me on Twitter at <code>@pkriens</code> then I&#8217;ll
              keep you posted.
            </p>
          </div>
          <div class="paragraph">
            <p><a href="mailto:peter.kriens@aQute.biz">Peter Kriens</a></p>
          </div>
        </div>
      </div>
    </div>
    <div id="footer">
      <div id="footer-text"></div>
    </div>
    <link rel="stylesheet" href="./coderay-asciidoctor.css" />
  </body>
</html>
